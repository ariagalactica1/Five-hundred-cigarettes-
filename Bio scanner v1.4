-- ZETA LABS // BIO-SCANNER (LocalScript, QoL+Themes+Sounds+HP system)
-- Event-driven, no render loops. Works for other players (client-replicated data).

--// Services
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local TeleportService = game:GetService("TeleportService")
local Lighting = game:GetService("Lighting")
local HttpService = game:GetService("HttpService")

local LocalPlayer = Players.LocalPlayer

--// Utility
local function round(inst, r) local u=Instance.new("UICorner"); u.CornerRadius=UDim.new(0,r); u.Parent=inst end
local function stroke(inst, t,c,tr) local s=Instance.new("UIStroke"); s.Thickness=t or 1; s.Color=c or Color3.new(1,1,1); s.Transparency=tr or 0.85; s.Parent=inst end
local function grad(inst, seq, rot) local g=Instance.new("UIGradient"); g.Color=seq; if rot then g.Rotation=rot end; g.Parent=inst; return g end
local function safeDisconnect(conn) if conn then pcall(function() conn:Disconnect() end) end end

--// Themes
local THEMES = {
	Dark = {
		bg=Color3.fromRGB(24,26,28), surface=Color3.fromRGB(30,33,36), surface2=Color3.fromRGB(36,40,44),
		text=Color3.fromRGB(230,240,240), subtle=Color3.fromRGB(160,180,185),
		accent=Color3.fromRGB(62,140,140), accentHi=Color3.fromRGB(90,190,190),
		danger=Color3.fromRGB(210,70,70), warn=Color3.fromRGB(255,200,40),
		barH1=Color3.fromRGB(30,200,120), barH2=Color3.fromRGB(240,170,0),
		barR1=Color3.fromRGB(100,150,255), barR2=Color3.fromRGB(130,220,255),
	},
	Light = {
		bg=Color3.fromRGB(240,244,248), surface=Color3.fromRGB(255,255,255), surface2=Color3.fromRGB(245,248,252),
		text=Color3.fromRGB(40,45,50), subtle=Color3.fromRGB(110,120,130),
		accent=Color3.fromRGB(0,140,170), accentHi=Color3.fromRGB(0,180,210),
		danger=Color3.fromRGB(210,70,70), warn=Color3.fromRGB(220,160,30),
		barH1=Color3.fromRGB(0,170,100), barH2=Color3.fromRGB(230,170,0),
		barR1=Color3.fromRGB(70,120,255), barR2=Color3.fromRGB(120,190,255),
	},
	Neon = {
		bg=Color3.fromRGB(10,12,14), surface=Color3.fromRGB(16,20,24), surface2=Color3.fromRGB(20,26,32),
		text=Color3.fromRGB(220,255,255), subtle=Color3.fromRGB(130,170,170),
		accent=Color3.fromRGB(0,255,170), accentHi=Color3.fromRGB(40,255,210),
		danger=Color3.fromRGB(255,80,120), warn=Color3.fromRGB(255,210,60),
		barH1=Color3.fromRGB(0,255,180), barH2=Color3.fromRGB(255,200,0),
		barR1=Color3.fromRGB(120,140,255), barR2=Color3.fromRGB(180,220,255),
	},
	Terminal = {
		bg=Color3.fromRGB(0,12,8), surface=Color3.fromRGB(8,16,12), surface2=Color3.fromRGB(12,20,16),
		text=Color3.fromRGB(0,255,120), subtle=Color3.fromRGB(0,200,100),
		accent=Color3.fromRGB(0,160,90), accentHi=Color3.fromRGB(0,200,120),
		danger=Color3.fromRGB(255,80,80), warn=Color3.fromRGB(255,200,80),
		barH1=Color3.fromRGB(0,255,120), barH2=Color3.fromRGB(200,255,120),
		barR1=Color3.fromRGB(0,180,120), barR2=Color3.fromRGB(140,255,200),
	},
}

--// Settings (with per-session save)
local DEFAULTS = {
	Theme = "Dark",
	Animations = true,
	Compact = false,
	FPSSaver = false,
	Sound = true,
	DefaultSpeed = 9,
	RunSpeed = 20,
	SafetyRefresh = 0, -- seconds; 0 = off
	HPEnabled = false,
	HPMode = "ALERT", -- ALERT | LEAVE | REJOIN
}

local function cloneTbl(t) local c={}; for k,v in pairs(t) do c[k]=v end; return c end
local SETTINGS = cloneTbl(DEFAULTS)

-- Simple client-only persistence (per session, and across respawns). If you need cross-session, add a tiny server script with DataStore.
local function cacheKey() return "ZETA_LOCAL_CACHE" end
local function saveSettings()
	local holder = LocalPlayer:FindFirstChild(cacheKey()) or Instance.new("StringValue")
	holder.Name = cacheKey(); holder.Value = HttpService:JSONEncode(SETTINGS); holder.Parent = LocalPlayer
end
local function loadSettings()
	local holder = LocalPlayer:FindFirstChild(cacheKey())
	if not holder then return end
	local ok, data = pcall(function() return HttpService:JSONDecode(holder.Value) end)
	if ok and typeof(data)=="table" then
		for k,v in pairs(DEFAULTS) do if data[k] ~= nil then SETTINGS[k] = data[k] end end
	end
end
loadSettings()

--// Derived/Theme
local RADIUS = 12
local TITLE_H = 36
local MIN_W, MIN_H, MAX_W, MAX_H = 320, 360, 900, 800
local function theme() return THEMES[SETTINGS.Theme] or THEMES.Dark end

--// Toast notifications
local gui = Instance.new("ScreenGui")
gui.Name = "Zeta Labs"; gui.ResetOnSpawn = false; gui.IgnoreGuiInset = false
gui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local toastArea = Instance.new("Frame")
toastArea.BackgroundTransparency = 1; toastArea.Size = UDim2.new(1,0,0,0); toastArea.Position = UDim2.new(0,0,0,8); toastArea.Parent = gui
local toastList = Instance.new("UIListLayout", toastArea)
toastList.HorizontalAlignment = Enum.HorizontalAlignment.Center
toastList.VerticalAlignment = Enum.VerticalAlignment.Top
toastList.Padding = UDim.new(0, 6)

-- Sounds
local sndFolder = Instance.new("Folder"); sndFolder.Name = "Sounds"; sndFolder.Parent = gui
local clickS = Instance.new("Sound"); clickS.SoundId = "rbxassetid://7149518155"; clickS.Volume = 0.25; clickS.Parent = sndFolder
local alertS = Instance.new("Sound"); alertS.SoundId = "rbxassetid://9118823105"; alertS.Volume = 0.35; alertS.Parent = sndFolder
local function play(snd) if SETTINGS.Sound then pcall(function() snd:Play() end) end end

local function notify(text, color)
	local pal = theme()
	local card = Instance.new("TextLabel")
	card.BackgroundColor3 = pal.surface2
	card.TextColor3 = color or pal.text
	card.Font = Enum.Font.Gotham; card.TextSize = 14; card.TextWrapped = true
	card.AutomaticSize = Enum.AutomaticSize.XY; card.Size = UDim2.new(0,0,0,0)
	card.Text = tostring(text); card.Parent = toastArea; card.ZIndex = 200
	round(card, 8); stroke(card, 1, pal.text, 0.85)
	local pad = Instance.new("UIPadding", card); pad.PaddingTop=UDim.new(0,6); pad.PaddingBottom=UDim.new(0,6); pad.PaddingLeft=UDim.new(0,10); pad.PaddingRight=UDim.new(0,10)
	if SETTINGS.Animations and not SETTINGS.FPSSaver then card.BackgroundTransparency=1; TweenService:Create(card, TweenInfo.new(0.12), {BackgroundTransparency=0}):Play() end
	task.delay(2.0, function()
		if card.Parent then
			if SETTINGS.Animations and not SETTINGS.FPSSaver then
				local t=TweenService:Create(card, TweenInfo.new(0.2), {BackgroundTransparency=1, TextTransparency=1}); t:Play(); t.Completed:Wait()
			end
			card:Destroy()
		end
	end)
end

--// Main frame
local main = Instance.new("Frame")
main.Size = UDim2.new(0, 460, 0, 540); main.Position = UDim2.new(0.5, -230, 0.5, -270)
main.BackgroundColor3 = theme().surface; main.BorderSizePixel=0; main.Parent = gui
round(main, RADIUS); stroke(main, 1, theme().text, 0.9)
if not SETTINGS.FPSSaver then
	grad(main, ColorSequence.new{
		ColorSequenceKeypoint.new(0, theme().surface2),
		ColorSequenceKeypoint.new(1, theme().surface)
	}, 90)
end

-- Title bar
local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1, 0, 0, TITLE_H); titleBar.BackgroundColor3 = theme().surface2
titleBar.BorderSizePixel=0; titleBar.Parent = main; round(titleBar, RADIUS)

local underline = Instance.new("Frame")
underline.Size = UDim2.new(1, 0, 0, 2); underline.Position = UDim2.new(0, 0, 1, -2)
underline.BackgroundColor3 = theme().accent; underline.Parent = titleBar

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -240, 1, 0); title.Position = UDim2.new(0, 12, 0, 0)
title.BackgroundTransparency=1; title.Font=Enum.Font.GothamBold; title.TextSize=20
title.Text = "ZETA LABS // BIO-SCANNER"; title.TextColor3 = theme().text; title.TextXAlignment=Enum.TextXAlignment.Left; title.Parent = titleBar

-- Right dock with fixed order (never flips)
local dock = Instance.new("Frame"); dock.BackgroundTransparency=1; dock.Size = UDim2.new(0, 250, 1, 0); dock.Position = UDim2.new(1, -260, 0, 0); dock.Parent = titleBar
local dockList = Instance.new("UIListLayout", dock)
dockList.FillDirection = Enum.FillDirection.Horizontal; dockList.HorizontalAlignment=Enum.HorizontalAlignment.Right
dockList.VerticalAlignment=Enum.VerticalAlignment.Center; dockList.Padding = UDim.new(0, 6)

local function iconButton(txt, name)
	local b = Instance.new("TextButton")
	b.Name = name or "Btn"; b.AutoButtonColor=false; b.Size = UDim2.new(0, 30, 0, 26)
	b.BackgroundTransparency=1; b.Text = txt; b.Font = Enum.Font.GothamBold; b.TextSize=16; b.TextColor3 = theme().text
	b.Parent = dock
	b.MouseButton1Click:Connect(function() play(clickS) end)
	return b
end

-- Order: ‚öô HP üéµ ‚ñÅ üóë X
local settingsBtn = iconButton("‚öô","Settings")
local hpBtn       = iconButton("HP","HP")
local soundBtn    = iconButton("üéµ","Sound")
local collapseBtn = iconButton("‚ñÅ","Collapse")
local uninjectBtn = iconButton("üóë","Uninject")
local closeBtn    = iconButton("X","Close"); closeBtn.TextColor3 = Color3.fromRGB(255,140,140); uninjectBtn.TextColor3 = Color3.fromRGB(255,100,100)

-- Body + Footer
local contentHolder = Instance.new("Frame"); contentHolder.BackgroundTransparency=1
contentHolder.Size = UDim2.new(1, -20, 1, -(TITLE_H + 90)); contentHolder.Position = UDim2.new(0, 10, 0, TITLE_H + 8); contentHolder.Parent = main

local footer = Instance.new("Frame"); footer.Size = UDim2.new(1, -20, 0, 82); footer.Position = UDim2.new(0, 10, 1, -90)
footer.BackgroundColor3 = theme().surface2; footer.Parent = main; round(footer, RADIUS-4); stroke(footer, 1, theme().text, 0.85)
local footerPad = Instance.new("UIPadding", footer); footerPad.PaddingTop=UDim.new(0,8); footerPad.PaddingBottom=UDim.new(0,8); footerPad.PaddingLeft=UDim.new(0,8); footerPad.PaddingRight=UDim.new(0,8)
local footerList = Instance.new("UIListLayout", footer); footerList.Padding=UDim.new(0,6); footerList.FillDirection=Enum.FillDirection.Vertical

-- Collapse
local collapsed = false; local savedSize = main.Size
local function setCollapsed(state)
	collapsed = state
	if SETTINGS.Animations and not SETTINGS.FPSSaver then
		TweenService:Create(main, TweenInfo.new(0.15, Enum.EasingStyle.Sine), {
			Size = state and UDim2.new(savedSize.X.Scale, savedSize.X.Offset, 0, TITLE_H + 8) or savedSize
		}):Play()
	else
		main.Size = state and UDim2.new(savedSize.X.Scale, savedSize.X.Offset, 0, TITLE_H + 8) or savedSize
	end
	contentHolder.Visible = not state; footer.Visible = not state
	collapseBtn.Text = state and "‚ñÉ" or "‚ñÅ"
end
collapseBtn.MouseButton1Click:Connect(function() setCollapsed(not collapsed) end)
closeBtn.MouseButton1Click:Connect(function() gui.Enabled = false end)

-- Modal (Uninject)
local dim = Instance.new("Frame"); dim.BackgroundColor3 = Color3.new(0,0,0); dim.BackgroundTransparency=0.6; dim.Visible=false; dim.ZIndex=500; dim.Size=UDim2.fromScale(1,1); dim.Parent = gui
local blur = Instance.new("BlurEffect"); blur.Size=0; blur.Enabled=false; blur.Parent = Lighting
local modal = Instance.new("Frame"); modal.Size=UDim2.new(0,300,0,120); modal.Position=UDim2.new(0.5,-150,0.5,-60)
modal.BackgroundColor3 = theme().surface2; modal.Visible=false; modal.ZIndex=510; modal.Parent=gui; round(modal,RADIUS-2); stroke(modal,1,theme().text,0.8)
local mTitle = Instance.new("TextLabel"); mTitle.BackgroundTransparency=1; mTitle.Size=UDim2.new(1,-20,0,28); mTitle.Position=UDim2.new(0,10,0,10)
mTitle.Font=Enum.Font.GothamBold; mTitle.TextSize=16; mTitle.Text="‚ö† CONFIRM UNINJECT"; mTitle.TextColor3=theme().warn; mTitle.Parent=modal
local mMsg = Instance.new("TextLabel"); mMsg.BackgroundTransparency=1; mMsg.Size=UDim2.new(1,-20,0,36); mMsg.Position=UDim2.new(0,10,0,44)
mMsg.Font=Enum.Font.Gotham; mMsg.TextWrapped=true; mMsg.TextSize=13; mMsg.TextColor3=theme().text; mMsg.Text="Are you sure? This will close the menu permanently."; mMsg.Parent=modal
local mYes = Instance.new("TextButton"); mYes.Size=UDim2.new(0,130,0,32); mYes.Position=UDim2.new(0,10,1,-42)
mYes.Text="YES, UNINJECT"; mYes.Font=Enum.Font.GothamBold; mYes.TextSize=13; mYes.TextColor3=theme().text; mYes.BackgroundColor3=theme().danger; mYes.Parent=modal; round(mYes, RADIUS-6)
local mNo = Instance.new("TextButton"); mNo.Size=UDim2.new(0,130,0,32); mNo.Position=UDim2.new(1,-140,1,-42)
mNo.Text="CANCEL"; mNo.Font=Enum.Font.GothamBold; mNo.TextSize=13; mNo.TextColor3=theme().text; mNo.BackgroundColor3=theme().surface; mNo.Parent=modal; round(mNo, RADIUS-6)

local function showModal(show)
	dim.Visible = show; modal.Visible = show; blur.Enabled = show
	if SETTINGS.Animations and not SETTINGS.FPSSaver then TweenService:Create(blur, TweenInfo.new(0.12), {Size = show and 8 or 0}):Play() end
end
uninjectBtn.MouseButton1Click:Connect(function() showModal(true) end)
mNo.MouseButton1Click:Connect(function() showModal(false) end)
mYes.MouseButton1Click:Connect(function() showModal(false); notify("Uninjected."); gui:Destroy() end)
UserInputService.InputBegan:Connect(function(input,gpe) if not gpe and modal.Visible and input.KeyCode==Enum.KeyCode.Escape then showModal(false) end end)

-- Content grid
local grid = Instance.new("UIGridLayout"); grid.Parent = contentHolder
grid.CellSize = UDim2.new(1,0,0,36); grid.FillDirectionMaxCells = 1; grid.SortOrder = Enum.SortOrder.LayoutOrder

-- Row 1: Target box + dropdown (ZIndex kept low; never covers title bar)
local targetRow = Instance.new("Frame"); targetRow.BackgroundTransparency=1; targetRow.LayoutOrder=1; targetRow.Parent=contentHolder
local targetBox = Instance.new("TextBox")
targetBox.Size=UDim2.new(1,0,1,0); targetBox.AnchorPoint=Vector2.new(0.5,0.5); targetBox.Position=UDim2.new(0.5,0,0.5,0)
targetBox.PlaceholderText = "Enter player name (leave empty for self)"
targetBox.BackgroundColor3 = theme().surface2; targetBox.TextColor3=theme().text; targetBox.Font=Enum.Font.Gotham
targetBox.TextSize = SETTINGS.Compact and 14 or 16; targetBox.ClearTextOnFocus=false; targetBox.Parent=targetRow
round(targetBox, RADIUS-4); stroke(targetBox, 1, theme().text, 0.85)

local dropdown = Instance.new("ScrollingFrame")
dropdown.Size=UDim2.new(1,0,0,110); dropdown.Position=UDim2.new(0,0,1,4); dropdown.BackgroundColor3=theme().surface2
dropdown.BorderSizePixel=0; dropdown.Visible=false; dropdown.ScrollBarThickness=6; dropdown.CanvasSize=UDim2.new(0,0,0,0); dropdown.ZIndex=9; dropdown.Parent=targetRow
round(dropdown, RADIUS-4); stroke(dropdown, 1, theme().text, 0.88)
local dropdownList = Instance.new("UIListLayout", dropdown); dropdownList.Padding = UDim.new(0,2)

local function rebuildDropdown(q)
	for _, ch in ipairs(dropdown:GetChildren()) do if ch:IsA("TextButton") then ch:Destroy() end end
	q = (q or ""):lower()
	local results = {}
	for _, p in ipairs(Players:GetPlayers()) do local n=p.Name:lower(); if q=="" or n:sub(1,#q)==q then table.insert(results,p) end end
	for _, p in ipairs(Players:GetPlayers()) do local n=p.Name:lower(); if q~="" and n:find(q,1,true) and n:sub(1,#q)~=q then table.insert(results,p) end end
	for _, p in ipairs(results) do
		local b = Instance.new("TextButton"); b.Size=UDim2.new(1,-8,0,28); b.BackgroundColor3=theme().surface; b.Text=p.Name
		b.Font=Enum.Font.Gotham; b.TextSize=14; b.TextColor3=theme().text; b.TextXAlignment=Enum.TextXAlignment.Left; b.ZIndex=10; b.Parent=dropdown
		local pad=Instance.new("UIPadding",b); pad.PaddingLeft=UDim.new(0,10); round(b,RADIUS-6); stroke(b,1,theme().text,0.9)
		b.MouseButton1Click:Connect(function() targetBox.Text=p.Name; dropdown.Visible=false; if _G.rewireForTarget then _G.rewireForTarget(p) end end)
	end
	dropdown.CanvasSize = UDim2.new(0,0,0, dropdownList.AbsoluteContentSize.Y)
end
local typingPending=false
targetBox:GetPropertyChangedSignal("Text"):Connect(function()
	if not targetBox:IsFocused() or typingPending then return end
	typingPending=true; task.delay(0.08,function() typingPending=false; rebuildDropdown(targetBox.Text) end)
end)
targetBox.Focused:Connect(function() rebuildDropdown(targetBox.Text); dropdown.Visible=true end)
targetBox.FocusLost:Connect(function() task.wait(0.1); dropdown.Visible=false end)

-- Row 2: Tabs
local tabsRow = Instance.new("Frame"); tabsRow.BackgroundTransparency=1; tabsRow.LayoutOrder=2; tabsRow.Parent=contentHolder
local tabContainer = Instance.new("Frame"); tabContainer.BackgroundTransparency=1; tabContainer.Size=UDim2.new(1,0,1,0); tabContainer.Parent=tabsRow
local function tabBtn(txt,pos)
	local b=Instance.new("TextButton"); b.Size=UDim2.new(0.48,0,1,0); b.Position=UDim2.new(pos,0,0,0)
	b.Text=txt; b.Font=Enum.Font.GothamBold; b.TextSize=14; b.BackgroundColor3=theme().surface2; b.TextColor3=theme().subtle; b.BorderSizePixel=0; b.AutoButtonColor=false; b.Parent=tabContainer
	round(b,RADIUS-4); stroke(b,1,theme().text,0.88); return b
end
local tab1Btn = tabBtn("BIO DATA",0)
local tab2Btn = tabBtn("STATS",0.52)

-- Row 3: Content panes (with proper layout/padding to prevent stacking)
local contentRow = Instance.new("Frame"); contentRow.BackgroundTransparency=1; contentRow.LayoutOrder=3; contentRow.Size=UDim2.new(1,0,0,9999); contentRow.Parent=contentHolder
local contentFrame = Instance.new("Frame"); contentFrame.Size=UDim2.new(1,0,1,0); contentFrame.BackgroundTransparency=1; contentFrame.Parent=contentRow

local tab1Content = Instance.new("Frame"); tab1Content.Size=UDim2.new(1,0,1,0); tab1Content.BackgroundTransparency=1; tab1Content.Visible=true;  tab1Content.Parent=contentFrame
local t1Pad = Instance.new("UIPadding",tab1Content); t1Pad.PaddingTop=UDim.new(0,8); t1Pad.PaddingLeft=UDim.new(0,10); t1Pad.PaddingRight=UDim.new(0,10)
local t1Layout = Instance.new("UIListLayout",tab1Content); t1Layout.FillDirection=Enum.FillDirection.Vertical; t1Layout.Padding=UDim.new(0,6)

local tab2Content = Instance.new("Frame"); tab2Content.Size=UDim2.new(1,0,1,0); tab2Content.BackgroundTransparency=1; tab2Content.Visible=false; tab2Content.Parent=contentFrame
local t2Pad = Instance.new("UIPadding",tab2Content); t2Pad.PaddingTop=UDim.new(0,8); t2Pad.PaddingLeft=UDim.new(0,10); t2Pad.PaddingRight=UDim.new(0,10)
local t2Layout = Instance.new("UIListLayout",tab2Content); t2Layout.FillDirection=Enum.FillDirection.Vertical; t2Layout.Padding=UDim.new(0,6)

local function setTabVisual(a,b) a.BackgroundColor3=theme().accent; a.TextColor3=theme().text; b.BackgroundColor3=theme().surface2; b.TextColor3=theme().subtle end
local function switchTab(n) tab1Content.Visible=(n==1); tab2Content.Visible=(n==2); if n==1 then setTabVisual(tab1Btn,tab2Btn) else setTabVisual(tab2Btn,tab1Btn) end end
tab1Btn.MouseButton1Click:Connect(function() switchTab(1) end)
tab2Btn.MouseButton1Click:Connect(function() switchTab(2) end)
switchTab(1)

local function mkLabel(name,parent)
	local l=Instance.new("TextLabel"); l.Name=name; l.Size=UDim2.new(1,0,0, SETTINGS.Compact and 20 or 22)
	l.BackgroundTransparency=1; l.Font=Enum.Font.Gotham; l.TextSize=SETTINGS.Compact and 14 or 16
	l.TextColor3=Color3.fromRGB(200,255,200); l.Text=(name..": [N/A]"); l.TextXAlignment=Enum.TextXAlignment.Left; l.Parent=parent; return l
end

-- BIO labels
local tab1Labels = {
	Subject = mkLabel("Subject", tab1Content),
	Exposure = mkLabel("Exposure", tab1Content),
	Strength = mkLabel("Strength", tab1Content),
	Agility = mkLabel("Agility", tab1Content),
	Intelligence = mkLabel("Intelligence", tab1Content),
	MutationType = mkLabel("MutationType", tab1Content),
	PotentialEvolution = mkLabel("PotentialEvolution", tab1Content),
	HasReachedAdvancedMutation = mkLabel("AdvancedMutation", tab1Content),
	Weight = mkLabel("Weight", tab1Content),
	Health = mkLabel("Health", tab1Content),
}

-- STATS labels
local tab2Labels = {
	Resilience = mkLabel("Resilience", tab2Content),
	["Max Resilience"] = mkLabel("Max Resilience", tab2Content),
	WalkSpeed = mkLabel("WalkSpeed", tab2Content),
	["Speed Difference"] = mkLabel("Speed Difference", tab2Content),
	["Region Code"] = mkLabel("Region Code", tab2Content),
	["Is Elite"] = mkLabel("Is Elite", tab2Content),
	["Current Zone"] = mkLabel("Current Zone", tab2Content),
	Credits = mkLabel("Credits", tab2Content),
	["Active Perks"] = mkLabel("Active Perks", tab2Content),
}

-- Footer bars
local function bar(bg, labelText, c1, c2)
	local row = Instance.new("Frame"); row.BackgroundTransparency=1; row.Size=UDim2.new(1,0,0,30); row.Parent=footer
	local lab = Instance.new("TextLabel"); lab.BackgroundTransparency=1; lab.Size=UDim2.new(0.22,0,1,0); lab.Font=Enum.Font.GothamBold; lab.TextSize=14; lab.TextXAlignment=Enum.TextXAlignment.Left
	lab.TextColor3=theme().text; lab.Text=labelText; lab.Parent=row
	local bgBar = Instance.new("Frame"); bgBar.Size=UDim2.new(0.76,0,0.56,0); bgBar.Position=UDim2.new(0.23,0,0.22,0); bgBar.Parent=row
	bgBar.BackgroundColor3 = theme().surface; round(bgBar,RADIUS-6); stroke(bgBar,1,theme().text,0.88)
	local fill = Instance.new("Frame"); fill.Size=UDim2.new(0,0,1,0); fill.Parent=bgBar; fill.BorderSizePixel=0; round(fill,RADIUS-6)
	if not SETTINGS.FPSSaver then grad(fill, ColorSequence.new{ColorSequenceKeypoint.new(0,c1),ColorSequenceKeypoint.new(1,c2)}) end
	return fill
end
local function colorsHealth() if SETTINGS.FPSSaver then return theme().barH1, theme().barH1 end return theme().barH1, theme().barH2 end
local function colorsResil()  if SETTINGS.FPSSaver then return theme().barR1, theme().barR1 end return theme().barR1, theme().barR2 end
local healthBar = (function() local c1,c2=colorsHealth(); return bar(footer,"Health",c1,c2) end)()
local resilienceBar = (function() local c1,c2=colorsResil(); return bar(footer,"Resilience",c1,c2) end)()
local function tweenBar(fill, pct)
	pct = math.clamp(pct,0,1)
	if SETTINGS.Animations and not SETTINGS.FPSSaver then TweenService:Create(fill, TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size=UDim2.new(pct,0,1,0)}):Play()
	else fill.Size = UDim2.new(pct,0,1,0) end
end

-- Drag + Resize
do
	local dragging=false; local dragInput; local mousePos; local framePos
	titleBar.InputBegan:Connect(function(input)
		if input.UserInputType==Enum.UserInputType.MouseButton1 then dragging=true; mousePos=input.Position; framePos=main.Position
			input.Changed:Connect(function() if input.UserInputState==Enum.UserInputState.End then dragging=false end end)
		end
	end)
	titleBar.InputChanged:Connect(function(input) if input.UserInputType==Enum.UserInputType.MouseMovement then dragInput=input end end)
	UserInputService.InputChanged:Connect(function(input)
		if input==dragInput and dragging then local d=input.Position-mousePos; main.Position = UDim2.new(framePos.X.Scale, framePos.X.Offset+d.X, framePos.Y.Scale, framePos.Y.Offset+d.Y) end
	end)
	local resizing=false; local resizeStart; local sizeStart
	local resizeHandle = Instance.new("TextButton"); resizeHandle.Size=UDim2.new(0,20,0,20); resizeHandle.Position=UDim2.new(1,-24,1,-24)
	resizeHandle.Text="‚ã∞"; resizeHandle.Font=Enum.Font.GothamBold; resizeHandle.TextSize=16; resizeHandle.TextColor3=theme().text; resizeHandle.BackgroundTransparency=1; resizeHandle.Parent=main
	resizeHandle.MouseButton1Click:Connect(function() play(clickS) end)
	resizeHandle.InputBegan:Connect(function(input)
		if input.UserInputType==Enum.UserInputType.MouseButton1 then resizing=true; resizeStart=input.Position; sizeStart=main.Size
			input.Changed:Connect(function() if input.UserInputState==Enum.UserInputState.End then resizing=false end end)
		end
	end)
	UserInputService.InputChanged:Connect(function(input)
		if input.UserInputType==Enum.UserInputType.MouseMovement and resizing then
			local d=input.Position-resizeStart; local w=math.clamp(sizeStart.X.Offset+d.X, MIN_W, MAX_W); local h=math.clamp(sizeStart.Y.Offset+d.Y, MIN_H, MAX_H)
			main.Size = UDim2.new(0,w,0,h); if not collapsed then savedSize=main.Size end
		end
	end)
end

-- Keybind
UserInputService.InputBegan:Connect(function(input,gpe) if gpe then return end if input.KeyCode==Enum.KeyCode.P then gui.Enabled = not gui.Enabled end end)

-- Data/Signals
local function getChar(p) return p and p.Character or nil end
local function getHealth(char) local hum=char and char:FindFirstChildOfClass("Humanoid"); if hum then return hum.Health, hum.MaxHealth, hum end end
local connections = {}
local function disconnectAll() for _,c in ipairs(connections) do safeDisconnect(c) end table.clear(connections) end

local function updateTab1(target)
	local char = getChar(target)
	if not char then for _,l in pairs(tab1Labels) do l.Text="[NO DATA]" end; healthBar.Size=UDim2.new(0,0,1,0); return end
	local function charAttr(n) return char:GetAttribute(n) or "N/A" end
	local function plyAttr(n) return target:GetAttribute(n) or "N/A" end
	local h,mh = getHealth(char)
	tab1Labels.Subject.Text = "Subject: "..target.Name
	tab1Labels.Exposure.Text = "Exposure: "..tostring(charAttr("Exposure"))
	tab1Labels.Strength.Text = "Strength: "..tostring(charAttr("StrengthAttribute"))
	tab1Labels.Agility.Text = "Agility: "..tostring(charAttr("AgilityAttribute"))
	tab1Labels.Intelligence.Text = "Intelligence: "..tostring(charAttr("IntelligenceAttribute"))
	tab1Labels.MutationType.Text = "MutationType: "..tostring(charAttr("MutationType"))
	tab1Labels.PotentialEvolution.Text = "PotentialEvolution: "..tostring(charAttr("PotentialEvolution"))
	tab1Labels.HasReachedAdvancedMutation.Text = "AdvancedMutation: "..tostring(charAttr("HasReachedAdvancedMutation"))
	local w = plyAttr("Weight"); local wn=tonumber(w); local wt="Weight: "..tostring(w)..(wn and " kg" or "")
	if wn then
		local col=Color3.fromRGB(200,255,200); local tag=""
		if math.abs(wn-77.2)<1e-6 then col=Color3.fromRGB(255,215,0); tag=" [PERFECT]"
		elseif wn>=60 and wn<80 then col=Color3.fromRGB(100,255,100); tag=" [Average]"
		elseif wn>=80 and wn<=120 then col=Color3.fromRGB(255,150,100); tag=" [Overweight]"
		elseif wn>=50 and wn<60 then col=Color3.fromRGB(150,200,255); tag=" [Underweight]"
		else col=Color3.fromRGB(255,100,100); tag=" [Out of Range]" end
		tab1Labels.Weight.TextColor3=col; wt=wt..tag
	else tab1Labels.Weight.TextColor3=Color3.fromRGB(200,255,200) end
	tab1Labels.Weight.Text = wt
	if h and mh and mh>0 then tab1Labels.Health.Text=string.format("Health: %d / %d", h, mh); tweenBar(healthBar, h/mh) else tab1Labels.Health.Text="Health: N/A"; healthBar.Size=UDim2.new(0,0,1,0) end
end

local function updateTab2(target)
	local char=getChar(target)
	if not char then for _,l in pairs(tab2Labels) do l.Text="[NO DATA]" end; resilienceBar.Size=UDim2.new(0,0,1,0); return end
	local function charAttr(n) return char:GetAttribute(n) end
	local function plyAttr(n) return target:GetAttribute(n) end
	local r = plyAttr("Resilience") or charAttr("Resilience") or "N/A"
	local mr= plyAttr("MaxResilience") or charAttr("MaxResilience") or "N/A"
	tab2Labels.Resilience.Text = "Resilience: "..tostring(r); tab2Labels["Max Resilience"].Text="Max Resilience: "..tostring(mr)
	if typeof(r)=="number" and typeof(mr)=="number" and mr>0 then tweenBar(resilienceBar, r/mr) else resilienceBar.Size=UDim2.new(0,0,1,0) end
	local hum = char:FindFirstChildOfClass("Humanoid")
	if hum then
		local s=hum.WalkSpeed; local d=SETTINGS.DefaultSpeed; local rs=SETTINGS.RunSpeed; local diff=s-d; local diffText=(diff>=0 and "+" or "")..string.format("%.1f", diff)
		tab2Labels.WalkSpeed.Text=string.format("WalkSpeed: %.1f", s)
		tab2Labels["Speed Difference"].Text = string.format("Speed Difference: %s (Default: %g | Run: %g)", diffText, d, rs)
	else tab2Labels.WalkSpeed.Text="WalkSpeed: N/A"; tab2Labels["Speed Difference"].Text="Speed Difference: N/A" end
	tab2Labels["Region Code"].Text="Region Code: "..tostring(plyAttr("RegionCode") or charAttr("RegionCode") or "N/A")
	tab2Labels["Is Elite"].Text="Is Elite: "..tostring(plyAttr("IsElite") or charAttr("IsElite") or "N/A")
	tab2Labels["Current Zone"].Text="Current Zone: "..tostring(plyAttr("CurrentZone") or charAttr("CurrentZone") or "N/A")
	local data = target:FindFirstChild("Data"); local credits="N/A"
	if data then local v=data:FindFirstChild("Credits"); if v and typeof(v.Value)=="number" then local amt=math.floor(v.Value); credits=tostring(amt):reverse():gsub("(%d%d%d)","%1,"):reverse():gsub("^,","") end end
	tab2Labels.Credits.Text="Credits: "..credits
	local perks = {}
	if data then
		for _,ch in ipairs(data:GetChildren()) do
			if (ch:IsA("BoolValue") and ch.Value) or (ch:IsA("IntValue") and ch.Value>0 and ch.Name:lower():find("perk")) then table.insert(perks, ch.Name) end
		end
	end
	tab2Labels["Active Perks"].Text = (#perks>0) and ("Active Perks: "..table.concat(perks,", ")) or "Active Perks: None"
end

local currentTarget : Player? = nil
local function refreshAll() if currentTarget then updateTab1(currentTarget); updateTab2(currentTarget) else for _,l in pairs(tab1Labels) do l.Text="[NO DATA]" end; for _,l in pairs(tab2Labels) do l.Text="[NO DATA]" end end end

_G.rewireForTarget = function(target)
	if currentTarget == target then return end
	currentTarget = target; disconnectAll(); refreshAll()
	if not target then return end
	local function bindHum()
		local char=getChar(target); local hum=char and char:FindFirstChildOfClass("Humanoid")
		if hum then
			table.insert(connections, hum.HealthChanged:Connect(function() updateTab1(target) end))
			table.insert(connections, hum:GetPropertyChangedSignal("MaxHealth"):Connect(function() updateTab1(target) end))
			table.insert(connections, hum:GetPropertyChangedSignal("WalkSpeed"):Connect(function() updateTab2(target) end))
		end
	end
	table.insert(connections, target.CharacterAdded:Connect(function() task.defer(refreshAll); task.delay(0.05, bindHum) end))
	bindHum()
	table.insert(connections, target.AttributeChanged:Connect(function() updateTab1(target); updateTab2(target) end))
	local c=getChar(target); if c then table.insert(connections, c.AttributeChanged:Connect(function() updateTab1(target); updateTab2(target) end)) end
	local data = target:FindFirstChild("Data")
	if data then
		table.insert(connections, data.ChildAdded:Connect(function() updateTab2(target) end))
		table.insert(connections, data.ChildRemoved:Connect(function() updateTab2(target) end))
		for _,ch in ipairs(data:GetChildren()) do table.insert(connections, ch.Changed:Connect(function() updateTab2(target) end)) end
	end
	-- Optional safety refresh (off by default)
	if SETTINGS.SafetyRefresh and SETTINGS.SafetyRefresh>0 then
		local thisTarget = target
		task.spawn(function()
			while currentTarget == thisTarget do task.wait(SETTINGS.SafetyRefresh); if currentTarget == thisTarget then refreshAll() end end
		end)
	end
end

-- target from box
local function resolveTarget() local t=targetBox.Text; return (t=="" and LocalPlayer) or Players:FindFirstChild(t) end
local function applyBoxTarget() _G.rewireForTarget(resolveTarget()) end
targetBox.FocusLost:Connect(function(enter) if enter then applyBoxTarget() end end); targetBox.FocusLost:Connect(function() applyBoxTarget() end)
_G.rewireForTarget(LocalPlayer)

-- Settings Panel
local settingsPanel = Instance.new("Frame"); settingsPanel.Visible=false; settingsPanel.ZIndex=300
settingsPanel.Size=UDim2.new(0, 290, 0, 320); settingsPanel.Position=UDim2.new(1,-300,0,TITLE_H+8)
settingsPanel.BackgroundColor3=theme().surface2; settingsPanel.Parent=main; round(settingsPanel,RADIUS-2); stroke(settingsPanel,1,theme().text,0.85)
local spPad=Instance.new("UIPadding",settingsPanel); spPad.PaddingTop=UDim2.new(0,8); spPad.PaddingLeft=UDim2.new(0,8); spPad.PaddingRight=UDim2.new(0,8); spPad.PaddingBottom=UDim2.new(0,8)
local spList=Instance.new("UIListLayout",settingsPanel); spList.FillDirection=Enum.FillDirection.Vertical; spList.Padding=UDim.new(0,6)

local function row(h) local f=Instance.new("Frame"); f.BackgroundTransparency=1; f.Size=UDim2.new(1,0,0,h); f.Parent=settingsPanel; return f end
local header=row(24); local htxt=Instance.new("TextLabel"); htxt.BackgroundTransparency=1; htxt.Font=Enum.Font.GothamBold; htxt.TextSize=16; htxt.TextXAlignment=Enum.TextXAlignment.Left
htxt.TextColor3=theme().text; htxt.Text="Settings"; htxt.Size=UDim2.new(1,0,1,0); htxt.Parent=header

local function toggleRow(label, get, set)
	local r=row(28)
	local t=Instance.new("TextLabel"); t.BackgroundTransparency=1; t.Text=label; t.TextXAlignment=Enum.TextXAlignment.Left; t.Font=Enum.Font.Gotham; t.TextSize=14; t.TextColor3=theme().text; t.Size=UDim2.new(1,-44,1,0); t.Parent=r
	local b=Instance.new("TextButton"); b.Size=UDim2.new(0,36,0,22); b.Position=UDim2.new(1,-40,0.5,-11)
	b.Text = get() and "ON" or "OFF"; b.Font=Enum.Font.GothamBold; b.TextSize=12; b.TextColor3=theme().text; b.BackgroundColor3 = get() and theme().accent or theme().surface; b.Parent=r; round(b,10)
	b.MouseButton1Click:Connect(function() play(clickS); local v=not get(); set(v); b.Text=v and "ON" or "OFF"; b.BackgroundColor3 = v and theme().accent or theme().surface; saveSettings(); notify(label..": "..(v and "ON" or "OFF"), theme().subtle) end)
end
local function numberRow(label, get, set)
	local r=row(28)
	local t=Instance.new("TextLabel"); t.BackgroundTransparency=1; t.Text=label; t.TextXAlignment=Enum.TextXAlignment.Left; t.Font=Enum.Font.Gotham; t.TextSize=14; t.TextColor3=theme().text; t.Size=UDim2.new(1,-80,1,0); t.Parent=r
	local b=Instance.new("TextBox"); b.Size=UDim2.new(0,70,0,22); b.Position=UDim2.new(1,-74,0.5,-11)
	b.BackgroundColor3=theme().surface; b.TextColor3=theme().text; b.Font=Enum.Font.Gotham; b.TextSize=14; b.ClearTextOnFocus=false; b.Text=tostring(get()); b.Parent=r; round(b,8); stroke(b,1,theme().text,0.88)
	b.FocusLost:Connect(function() local v=tonumber(b.Text); if v then set(v) end; b.Text=tostring(get()); saveSettings(); notify(label..": "..b.Text, theme().subtle) end)
end
local function dropdownRow(label, options, get, set)
	local r=row(28)
	local t=Instance.new("TextLabel"); t.BackgroundTransparency=1; t.Text=label; t.TextXAlignment=Enum.TextXAlignment.Left; t.Font=Enum.Font.Gotham; t.TextSize=14; t.TextColor3=theme().text; t.Size=UDim2.new(1,-110,1,0); t.Parent=r
	local b=Instance.new("TextButton"); b.Size=UDim2.new(0,100,0,22); b.Position=UDim2.new(1,-104,0.5,-11)
	b.Text = tostring(get()); b.Font=Enum.Font.GothamBold; b.TextSize=12; b.TextColor3=theme().text; b.BackgroundColor3=theme().surface; b.Parent=r; round(b,8)
	local open=false; local menu
	b.MouseButton1Click:Connect(function()
		play(clickS)
		if menu then menu:Destroy(); menu=nil; open=false; return end
		open=true; menu=Instance.new("Frame"); menu.Size=UDim2.new(0,110,0, (#options*24)+8); menu.Position=UDim2.new(1,-112,0,22)
		menu.BackgroundColor3=theme().surface; menu.ZIndex=350; menu.Parent=r; round(menu,8); stroke(menu,1,theme().text,0.85)
		local l=Instance.new("UIListLayout",menu); l.Padding=UDim.new(0,4)
		for _,opt in ipairs(options) do
			local it=Instance.new("TextButton"); it.Size=UDim2.new(1,-8,0,20); it.Position=UDim2.new(0,4,0,0)
			it.Text=opt; it.Font=Enum.Font.Gotham; it.TextSize=12; it.TextColor3=theme().text; it.BackgroundColor3=theme().surface2; it.Parent=menu; round(it,6)
			it.MouseButton1Click:Connect(function()
				b.Text=opt; set(opt); saveSettings(); notify("Theme: "..opt, theme().subtle)
				-- soft reload theme on major elements
				gui:Destroy() -- simplest: rebuild UI with new theme to avoid missing recolors
				script.Disabled=true; script.Disabled=false
			end)
		end
	end)
end

-- Build panel
dropdownRow("Theme", {"Dark","Light","Neon","Terminal"}, function() return SETTINGS.Theme end, function(v) SETTINGS.Theme=v end)
toggleRow("Animations", function() return SETTINGS.Animations end, function(v) SETTINGS.Animations=v end)
toggleRow("Compact Mode", function() return SETTINGS.Compact end, function(v) SETTINGS.Compact=v for _,l in pairs(tab1Labels) do l.TextSize=v and 14 or 16; l.Size=UDim2.new(1,0,0,v and 20 or 22) end for _,l in pairs(tab2Labels) do l.TextSize=v and 14 or 16; l.Size=UDim2.new(1,0,0,v and 20 or 22) end targetBox.TextSize = v and 14 or 16 end)
toggleRow("FPS Saver", function() return SETTINGS.FPSSaver end, function(v) SETTINGS.FPSSaver=v end)
toggleRow("Sound", function() return SETTINGS.Sound end, function(v) SETTINGS.Sound=v end)
numberRow("Default Speed", function() return SETTINGS.DefaultSpeed end, function(n) SETTINGS.DefaultSpeed=n; refreshAll() end)
numberRow("Run Speed", function() return SETTINGS.RunSpeed end, function(n) SETTINGS.RunSpeed=n; refreshAll() end)
numberRow("Safety Refresh (s)", function() return SETTINGS.SafetyRefresh end, function(n) SETTINGS.SafetyRefresh=math.max(0,n) end)

settingsBtn.MouseButton1Click:Connect(function() settingsPanel.Visible = not settingsPanel.Visible end)
soundBtn.MouseButton1Click:Connect(function() SETTINGS.Sound = not SETTINGS.Sound; saveSettings(); notify("Sound: "..(SETTINGS.Sound and "ON" or "OFF"), theme().subtle) end)

-- HP System
local HP = { Enabled = SETTINGS.HPEnabled, Mode = SETTINGS.HPMode } -- mirror to keep button visuals independent while editing settings
local hpAlert = Instance.new("TextLabel"); hpAlert.BackgroundColor3=Color3.fromRGB(90,20,20); hpAlert.TextColor3=Color3.fromRGB(255,220,220)
hpAlert.Font=Enum.Font.GothamBold; hpAlert.TextSize=14; hpAlert.TextWrapped=true; hpAlert.Visible=false; hpAlert.ZIndex=250
hpAlert.Size=UDim2.new(0,360,0,28); hpAlert.AnchorPoint=Vector2.new(0.5,0); hpAlert.Position=UDim2.new(0.5,0,0,TITLE_H+6); hpAlert.Parent=main; round(hpAlert,8); stroke(hpAlert,1,theme().danger,0.25)
local function hpBtnVisual()
	local pal=theme()
	local col = (HP.Mode=="ALERT" and pal.warn) or (HP.Mode=="LEAVE" and pal.danger) or (HP.Mode=="REJOIN" and pal.accentHi) or pal.text
	hpBtn.TextColor3 = HP.Enabled and col or pal.subtle
end
hpBtnVisual()
hpBtn.MouseButton2Click:Connect(function()
	HP.Mode = (HP.Mode=="ALERT" and "LEAVE") or (HP.Mode=="LEAVE" and "REJOIN") or "ALERT"
	SETTINGS.HPMode = HP.Mode; saveSettings(); hpBtnVisual(); notify("HP mode: "..HP.Mode, theme().subtle)
end)
hpBtn.MouseButton1Click:Connect(function()
	HP.Enabled = not HP.Enabled; SETTINGS.HPEnabled = HP.Enabled; saveSettings(); hpBtnVisual(); notify("HP system "..(HP.Enabled and "ENABLED" or "DISABLED"), theme().subtle)
end)

local lastHealth, humConn
local function unbindHumanoid() safeDisconnect(humConn); humConn=nil end
local function bindLocalHumanoid()
	unbindHumanoid()
	local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
	local hum = char:FindFirstChildOfClass("Humanoid")
	if not hum then
		char.ChildAdded:Wait(); hum = char:FindFirstChildOfClass("Humanoid")
	end
	lastHealth = hum and hum.Health or nil
	if hum then
		humConn = hum.HealthChanged:Connect(function(newH)
			if not HP.Enabled then lastHealth=newH; return end
			local old = lastHealth or newH; lastHealth=newH
			local drop = math.max(0, old - newH)
			if drop <= 0 then return end
			if HP.Mode == "ALERT" then
				hpAlert.Text = ("‚ö† HP LOSS DETECTED ‚Äî Lost %d HP | Current: %d"):format(math.floor(drop), math.floor(newH))
				hpAlert.Visible=true; hpAlert.BackgroundTransparency=0; hpAlert.TextTransparency=0; play(alertS)
				if SETTINGS.Animations and not SETTINGS.FPSSaver then local t=TweenService:Create(hpAlert, TweenInfo.new(0.12), {BackgroundTransparency=0, TextTransparency=0}); t:Play() end
				task.delay(2.0, function()
					if hpAlert and hpAlert.Visible then
						if SETTINGS.Animations and not SETTINGS.FPSSaver then local t2=TweenService:Create(hpAlert, TweenInfo.new(0.22), {BackgroundTransparency=1, TextTransparency=1}); t2:Play(); t2.Completed:Wait() end
						hpAlert.Visible=false
					end
				end)
				notify(("HP -%d (now %d)"):format(math.floor(drop), math.floor(newH)), theme().warn)
			elseif HP.Mode == "LEAVE" then
				notify("HP drop detected ‚Äî disconnecting...", theme().danger)
				pcall(function() LocalPlayer:Kick("Disconnected by HP Alert") end)
			elseif HP.Mode == "REJOIN" then
				notify("HP drop detected ‚Äî rejoining...", theme().accentHi)
				task.delay(0.4, function() pcall(function() TeleportService:Teleport(game.PlaceId, LocalPlayer) end) end)
			end
		end)
	end
end
LocalPlayer.CharacterAdded:Connect(function() task.defer(bindLocalHumanoid) end)
if LocalPlayer.Character then bindLocalHumanoid() else LocalPlayer.CharacterAdded:Wait(); bindLocalHumanoid() end

-- Apply saved HP state on load
hpBtnVisual()

-- Final: ensure initial target is self
refreshAll()
