-- ZETA LABS // BIO-SCANNER (LocalScript, polished)
-- - Title bar right-dock: ‚öô (Settings), HP (Alert/Leave/Rejoin), ‚ñÅ (Collapse), üóë (Uninject), ‚úï (Close)
-- - Working Settings panel, working Uninject modal
-- - Footer Health/Resilience bars
-- - Event-driven updates for target, attributes, humanoid health/speed
-- - Health Alert / Rejoin / Disconnect system (no loops; uses Humanoid.HealthChanged)
-- - notify() toasts

-----------------------
-- Services & Locals --
-----------------------
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local TeleportService = game:GetService("TeleportService")
local Lighting = game:GetService("Lighting")

local LocalPlayer = Players.LocalPlayer

----------------
-- Appearance --
----------------
local PALETTE = {
	bg         = Color3.fromRGB(24, 26, 28),
	surface    = Color3.fromRGB(30, 33, 36),
	surface2   = Color3.fromRGB(36, 40, 44),
	text       = Color3.fromRGB(230, 240, 240),
	textSubtle = Color3.fromRGB(160, 180, 185),
	stroke     = Color3.fromRGB(255, 255, 255),
	accent     = Color3.fromRGB(62, 140, 140),
	accentHi   = Color3.fromRGB(90, 190, 190),
	danger     = Color3.fromRGB(210, 70, 70),
	good       = Color3.fromRGB(0, 200, 120),
	warn       = Color3.fromRGB(255, 200, 40),
	blue1      = Color3.fromRGB(90, 120, 255),
	blue2      = Color3.fromRGB(140, 200, 255),
}
local RADIUS = 12
local TITLE_H = 36
local MIN_W, MIN_H, MAX_W, MAX_H = 320, 360, 900, 800

----------------
-- Live State --
----------------
local SETTINGS = {
	Animations = true,
	CompactMode = false,
	ColorblindBars = false,
	ShadowEnabled = false,
	DefaultSpeed = 9,
	RunSpeed = 20,
	SafetyRefreshSeconds = 0, -- optional; for non-local targets you can set >0 in panel if you want
}

-- HP Alert system state
local HPState = {
	Enabled = false,
	Mode = "ALERT", -- "ALERT" | "LEAVE" | "REJOIN"
}

-----------------
-- GUI Helpers --
-----------------
local function uiStroke(parent, t, c, tr)
	local s = Instance.new("UIStroke")
	s.Thickness = t or 1
	s.Color = c or PALETTE.stroke
	s.Transparency = tr or 0.88
	s.Parent = parent
	return s
end
local function round(inst, r)
	local u = Instance.new("UICorner"); u.CornerRadius = UDim.new(0, r or (RADIUS-4)); u.Parent = inst; return u
end
local function gradient(inst, colSeq, rot)
	local g = Instance.new("UIGradient")
	g.Color = colSeq
	if rot then g.Rotation = rot end
	g.Parent = inst
	return g
end

------------------
-- Root ScreenGui
------------------
local gui = Instance.new("ScreenGui")
gui.Name = "Zeta Labs"
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = false
gui.Parent = LocalPlayer:WaitForChild("PlayerGui")

-- Toast area (notify)
local toastArea = Instance.new("Frame")
toastArea.Name = "ToastArea"
toastArea.BackgroundTransparency = 1
toastArea.Size = UDim2.new(1, 0, 0, 0)
toastArea.Position = UDim2.new(0, 0, 0, 8)
toastArea.Parent = gui
local toastList = Instance.new("UIListLayout", toastArea)
toastList.HorizontalAlignment = Enum.HorizontalAlignment.Center
toastList.VerticalAlignment = Enum.VerticalAlignment.Top
toastList.Padding = UDim.new(0, 6)

local function notify(text, color)
	local card = Instance.new("TextLabel")
	card.BackgroundColor3 = PALETTE.surface2
	card.TextColor3 = color or PALETTE.text
	card.Font = Enum.Font.Gotham
	card.TextSize = 14
	card.TextWrapped = true
	card.AutomaticSize = Enum.AutomaticSize.XY
	card.Size = UDim2.new(0, 0, 0, 0)
	card.Text = tostring(text)
	card.Parent = toastArea
	card.ZIndex = 50
	round(card, 8)
	uiStroke(card, 1, PALETTE.stroke, 0.85)
	local pad = Instance.new("UIPadding", card)
	pad.PaddingTop = UDim.new(0, 6); pad.PaddingBottom = UDim.new(0, 6)
	pad.PaddingLeft = UDim.new(0, 10); pad.PaddingRight = UDim.new(0, 10)
	if SETTINGS.Animations then
		card.BackgroundTransparency = 1
		TweenService:Create(card, TweenInfo.new(0.15), {BackgroundTransparency = 0}):Play()
	end
	task.delay(2.0, function()
		if card and card.Parent then
			if SETTINGS.Animations then
				local t = TweenService:Create(card, TweenInfo.new(0.2), {BackgroundTransparency = 1, TextTransparency = 1})
				t:Play(); t.Completed:Wait()
			end
			card:Destroy()
		end
	end)
end

----------------
-- Main Window --
----------------
local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 460, 0, 540)
frame.Position = UDim2.new(0.5, -230, 0.5, -270)
frame.BackgroundColor3 = PALETTE.surface
frame.BorderSizePixel = 0
frame.Parent = gui
round(frame, RADIUS)
uiStroke(frame, 1, PALETTE.stroke, 0.9)
gradient(frame, ColorSequence.new{
	ColorSequenceKeypoint.new(0, Color3.fromRGB(36,40,44)),
	ColorSequenceKeypoint.new(1, Color3.fromRGB(30,33,36)),
}, 90)

-- Title bar
local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1, 0, 0, TITLE_H)
titleBar.BackgroundColor3 = PALETTE.surface2
titleBar.BorderSizePixel = 0
titleBar.Parent = frame
round(titleBar, RADIUS)

local underline = Instance.new("Frame")
underline.Size = UDim2.new(1, 0, 0, 2)
underline.Position = UDim2.new(0, 0, 1, -2)
underline.BackgroundColor3 = PALETTE.accent
underline.Parent = titleBar

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -220, 1, 0)
title.Position = UDim2.new(0, 12, 0, 0)
title.BackgroundTransparency = 1
title.Font = Enum.Font.GothamBold
title.TextSize = 20
title.Text = "ZETA LABS // BIO-SCANNER"
title.TextColor3 = PALETTE.text
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = titleBar

-- Right-aligned button dock
local dock = Instance.new("Frame")
dock.BackgroundTransparency = 1
dock.Size = UDim2.new(0, 210, 1, 0)
dock.Position = UDim2.new(1, -220, 0, 0) -- leaves ~10px gap from edge
dock.Parent = titleBar

local dockList = Instance.new("UIListLayout", dock)
dockList.FillDirection = Enum.FillDirection.Horizontal
dockList.HorizontalAlignment = Enum.HorizontalAlignment.Right
dockList.VerticalAlignment = Enum.VerticalAlignment.Center
dockList.Padding = UDim.new(0, 6)

local function makeIconButton(txt, tooltip)
	local b = Instance.new("TextButton")
	b.AutoButtonColor = false
	b.Size = UDim2.new(0, 30, 0, 26)
	b.BackgroundTransparency = 1
	b.Text = txt
	b.Font = Enum.Font.GothamBold
	b.TextSize = 16
	b.TextColor3 = PALETTE.text
	b.Parent = dock
	b.Name = tooltip or "Btn"
	return b
end

-- Buttons in order: ‚öô HP ‚ñÅ üóë ‚úï
local settingsBtn = makeIconButton("‚öô", "Settings")
local hpBtn       = makeIconButton("HP", "HP System")
local collapseBtn = makeIconButton("‚ñÅ", "Collapse")
local uninjectBtn = makeIconButton("üóë", "Uninject")
local closeBtn    = makeIconButton("‚úï", "Close")
closeBtn.TextColor3 = Color3.fromRGB(255,140,140)
uninjectBtn.TextColor3 = Color3.fromRGB(255,100,100)

-- Body (top content) + Footer (bottom bars)
local contentHolder = Instance.new("Frame")
contentHolder.BackgroundTransparency = 1
contentHolder.Size = UDim2.new(1, -20, 1, -(TITLE_H + 90))
contentHolder.Position = UDim2.new(0, 10, 0, TITLE_H + 8)
contentHolder.Parent = frame

local footer = Instance.new("Frame")
footer.Size = UDim2.new(1, -20, 0, 82)
footer.Position = UDim2.new(0, 10, 1, -90)
footer.BackgroundColor3 = PALETTE.surface2
footer.Parent = frame
round(footer, RADIUS-4)
uiStroke(footer, 1, PALETTE.stroke, 0.85)
local footerPad = Instance.new("UIPadding", footer)
footerPad.PaddingTop = UDim.new(0, 8); footerPad.PaddingLeft = UDim.new(0, 8)
footerPad.PaddingRight = UDim.new(0, 8); footerPad.PaddingBottom = UDim.new(0, 8)
local footerList = Instance.new("UIListLayout", footer)
footerList.Padding = UDim.new(0, 6)
footerList.FillDirection = Enum.FillDirection.Vertical

-- Collapsing
local collapsed = false
local savedSize = frame.Size
local function setCollapsed(state)
	collapsed = state
	if SETTINGS.Animations then
		TweenService:Create(frame, TweenInfo.new(0.18, Enum.EasingStyle.Sine), {
			Size = state and UDim2.new(savedSize.X.Scale, savedSize.X.Offset, 0, TITLE_H + 8) or savedSize
		}):Play()
	else
		frame.Size = state and UDim2.new(savedSize.X.Scale, savedSize.X.Offset, 0, TITLE_H + 8) or savedSize
	end
	contentHolder.Visible = not state
	footer.Visible = not state
	collapseBtn.Text = state and "‚ñÉ" or "‚ñÅ"
end
collapseBtn.MouseButton1Click:Connect(function() setCollapsed(not collapsed) end)

-- Close
closeBtn.MouseButton1Click:Connect(function() gui.Enabled = false end)

------------------
-- Uninject Modal
------------------
local dim = Instance.new("Frame"); dim.BackgroundColor3 = Color3.new(0,0,0); dim.BackgroundTransparency=0.6
dim.Visible=false; dim.ZIndex=60; dim.Size = UDim2.fromScale(1,1); dim.Parent = gui

local blur = Instance.new("BlurEffect"); blur.Size=0; blur.Enabled=false; blur.Parent=Lighting

local confirmDialog = Instance.new("Frame")
confirmDialog.Size = UDim2.new(0, 300, 0, 120)
confirmDialog.Position = UDim2.new(0.5, -150, 0.5, -60)
confirmDialog.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
confirmDialog.Visible = false
confirmDialog.ZIndex = 70
confirmDialog.Parent = gui
round(confirmDialog, RADIUS-2)
uiStroke(confirmDialog, 1, PALETTE.stroke, 0.8)

local cTitle = Instance.new("TextLabel")
cTitle.BackgroundTransparency = 1
cTitle.Size = UDim2.new(1, -20, 0, 30)
cTitle.Position = UDim2.new(0, 10, 0, 10)
cTitle.Font = Enum.Font.GothamBold
cTitle.TextSize = 16
cTitle.Text = "‚ö† CONFIRM UNINJECT"
cTitle.TextColor3 = Color3.fromRGB(255, 200, 100)
cTitle.Parent = confirmDialog

local cMsg = Instance.new("TextLabel")
cMsg.BackgroundTransparency = 1
cMsg.Size = UDim2.new(1, -20, 0, 36)
cMsg.Position = UDim2.new(0, 10, 0, 44)
cMsg.Font = Enum.Font.Gotham
cMsg.TextSize = 13
cMsg.TextWrapped = true
cMsg.Text = "Are you sure you want to do this?\nThis will close the menu permanently."
cMsg.TextColor3 = PALETTE.text
cMsg.Parent = confirmDialog

local cYes = Instance.new("TextButton")
cYes.Size = UDim2.new(0, 130, 0, 32)
cYes.Position = UDim2.new(0, 10, 1, -42)
cYes.Text = "YES, UNINJECT"
cYes.Font = Enum.Font.GothamBold
cYes.TextSize = 13
cYes.TextColor3 = PALETTE.text
cYes.BackgroundColor3 = PALETTE.danger
cYes.Parent = confirmDialog
round(cYes, RADIUS-6)

local cNo = Instance.new("TextButton")
cNo.Size = UDim2.new(0, 130, 0, 32)
cNo.Position = UDim2.new(1, -140, 1, -42)
cNo.Text = "CANCEL"
cNo.Font = Enum.Font.GothamBold
cNo.TextSize = 13
cNo.TextColor3 = PALETTE.text
cNo.BackgroundColor3 = PALETTE.surface2
cNo.Parent = confirmDialog
round(cNo, RADIUS-6)

local function showConfirmModal(show)
	dim.Visible = show
	confirmDialog.Visible = show
	blur.Enabled = show
	if SETTINGS.Animations then
		TweenService:Create(blur, TweenInfo.new(0.15), {Size = show and 8 or 0}):Play()
	end
end
uninjectBtn.MouseButton1Click:Connect(function() showConfirmModal(true) end)
cNo.MouseButton1Click:Connect(function() showConfirmModal(false) end)
cYes.MouseButton1Click:Connect(function()
	showConfirmModal(false)
	notify("Uninjected.", PALETTE.text)
	gui:Destroy()
end)
UserInputService.InputBegan:Connect(function(input, gpe)
	if not gpe and confirmDialog.Visible and input.KeyCode == Enum.KeyCode.Escape then
		showConfirmModal(false)
	end
end)

---------------------
-- Top Content Area --
---------------------
local grid = Instance.new("UIGridLayout")
grid.Parent = contentHolder
grid.CellSize = UDim2.new(1, 0, 0, 36)
grid.FillDirectionMaxCells = 1
grid.SortOrder = Enum.SortOrder.LayoutOrder

-- Row 1: Target box + dropdown
local targetRow = Instance.new("Frame"); targetRow.BackgroundTransparency=1; targetRow.LayoutOrder=1; targetRow.Parent=contentHolder
local targetBox = Instance.new("TextBox")
targetBox.Size = UDim2.new(1, 0, 1, 0)
targetBox.AnchorPoint = Vector2.new(0.5,0.5)
targetBox.Position = UDim2.new(0.5,0,0.5,0)
targetBox.PlaceholderText = "Enter player name (leave empty for self)"
targetBox.BackgroundColor3 = PALETTE.surface2
targetBox.TextColor3 = PALETTE.text
targetBox.Font = Enum.Font.Gotham
targetBox.TextSize = SETTINGS.CompactMode and 14 or 16
targetBox.ClearTextOnFocus = false
targetBox.Parent = targetRow
round(targetBox, RADIUS-4)
uiStroke(targetBox, 1, PALETTE.stroke, 0.85)

local dropdown = Instance.new("ScrollingFrame")
dropdown.Size = UDim2.new(1, 0, 0, 110)
dropdown.Position = UDim2.new(0, 0, 1, 4)
dropdown.BackgroundColor3 = PALETTE.surface2
dropdown.BorderSizePixel = 0
dropdown.Visible = false
dropdown.ScrollBarThickness = 6
dropdown.CanvasSize = UDim2.new(0, 0, 0, 0)
dropdown.ZIndex = 10
dropdown.Parent = targetRow
round(dropdown, RADIUS-4)
uiStroke(dropdown, 1, PALETTE.stroke, 0.88)
local dropdownList = Instance.new("UIListLayout", dropdown)
dropdownList.Padding = UDim.new(0, 2)

local function rebuildDropdown(searchText)
	for _, child in ipairs(dropdown:GetChildren()) do
		if child:IsA("TextButton") then child:Destroy() end
	end
	searchText = (searchText or ""):lower()

	local results = {}
	for _, p in ipairs(Players:GetPlayers()) do
		local nm = p.Name:lower()
		if searchText == "" or nm:sub(1, #searchText) == searchText then table.insert(results, p) end
	end
	for _, p in ipairs(Players:GetPlayers()) do
		local nm = p.Name:lower()
		if searchText ~= "" and nm:find(searchText, 1, true) and nm:sub(1, #searchText) ~= searchText then
			table.insert(results, p)
		end
	end

	for _, p in ipairs(results) do
		local btn = Instance.new("TextButton")
		btn.Size = UDim2.new(1, -8, 0, 28)
		btn.BackgroundColor3 = PALETTE.surface
		btn.Text = p.Name
		btn.Font = Enum.Font.Gotham
		btn.TextSize = 14
		btn.TextColor3 = PALETTE.text
		btn.TextXAlignment = Enum.TextXAlignment.Left
		btn.ZIndex = 11
		btn.Parent = dropdown
		local pad = Instance.new("UIPadding", btn); pad.PaddingLeft = UDim.new(0, 10)
		round(btn, RADIUS-6)
		uiStroke(btn, 1, PALETTE.stroke, 0.9)
		btn.MouseButton1Click:Connect(function()
			targetBox.Text = p.Name
			dropdown.Visible = false
			if rewireForTarget then rewireForTarget(p) end
		end)
	end
	dropdown.CanvasSize = UDim2.new(0, 0, 0, dropdownList.AbsoluteContentSize.Y)
end

local typingPending = false
targetBox:GetPropertyChangedSignal("Text"):Connect(function()
	if not targetBox:IsFocused() then return end
	if typingPending then return end
	typingPending = true
	task.delay(0.08, function()
		typingPending = false
		rebuildDropdown(targetBox.Text)
	end)
end)
targetBox.Focused:Connect(function()
	rebuildDropdown(targetBox.Text)
	dropdown.Visible = true
end)
targetBox.FocusLost:Connect(function()
	task.wait(0.1)
	dropdown.Visible = false
end)

-- Row 2: Tabs
local tabsRow = Instance.new("Frame"); tabsRow.BackgroundTransparency=1; tabsRow.LayoutOrder=2; tabsRow.Parent=contentHolder
local tabContainer = Instance.new("Frame"); tabContainer.BackgroundTransparency=1; tabContainer.Size = UDim2.new(1,0,1,0); tabContainer.Parent = tabsRow
local function makeTabButton(text, position)
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(0.48, 0, 1, 0)
	btn.Position = UDim2.new(position, 0, 0, 0)
	btn.Text = text
	btn.Font = Enum.Font.GothamBold
	btn.TextSize = 14
	btn.BackgroundColor3 = PALETTE.surface2
	btn.TextColor3 = PALETTE.textSubtle
	btn.BorderSizePixel = 0
	btn.AutoButtonColor = false
	btn.Parent = tabContainer
	round(btn, RADIUS-4)
	uiStroke(btn, 1, PALETTE.stroke, 0.88)
	return btn
end
local tab1Btn = makeTabButton("BIO DATA", 0.00)
local tab2Btn = makeTabButton("STATS",    0.52)

-- Row 3: Content panes
local contentRow = Instance.new("Frame"); contentRow.BackgroundTransparency=1; contentRow.LayoutOrder=3; contentRow.Size=UDim2.new(1,0,0,9999); contentRow.Parent=contentHolder
local contentFrame = Instance.new("Frame"); contentFrame.Size=UDim2.new(1,0,1,0); contentFrame.BackgroundTransparency=1; contentFrame.Parent=contentRow
local tab1Content = Instance.new("Frame"); tab1Content.Size=UDim2.new(1,0,1,0); tab1Content.BackgroundTransparency=1; tab1Content.Visible=true;  tab1Content.Parent=contentFrame
local tab2Content = Instance.new("Frame"); tab2Content.Size=UDim2.new(1,0,1,0); tab2Content.BackgroundTransparency=1; tab2Content.Visible=false; tab2Content.Parent=contentFrame

local function setTabVisual(activeBtn, inactiveBtn)
	activeBtn.BackgroundColor3 = PALETTE.accent; activeBtn.TextColor3 = PALETTE.text
	inactiveBtn.BackgroundColor3 = PALETTE.surface2; inactiveBtn.TextColor3 = PALETTE.textSubtle
end
local function switchTab(n)
	tab1Content.Visible = (n==1); tab2Content.Visible = (n==2)
	if n==1 then setTabVisual(tab1Btn, tab2Btn) else setTabVisual(tab2Btn, tab1Btn) end
end
tab1Btn.MouseButton1Click:Connect(function() switchTab(1) end)
tab2Btn.MouseButton1Click:Connect(function() switchTab(2) end)
switchTab(1)

local function makeLabel(name, parent)
	local lbl = Instance.new("TextLabel")
	lbl.Name = name
	lbl.Size = UDim2.new(1, 0, 0, SETTINGS.CompactMode and 20 or 22)
	lbl.BackgroundTransparency = 1
	lbl.Font = Enum.Font.Gotham
	lbl.TextSize = SETTINGS.CompactMode and 14 or 16
	lbl.TextColor3 = Color3.fromRGB(200, 255, 200)
	lbl.Text = name .. ": [N/A]"
	lbl.TextXAlignment = Enum.TextXAlignment.Left
	lbl.Parent = parent
	return lbl
end

-- Tab 1 labels
local tab1Labels = {
	Subject = makeLabel("Subject", tab1Content),
	Exposure = makeLabel("Exposure", tab1Content),
	Strength = makeLabel("Strength", tab1Content),
	Agility = makeLabel("Agility", tab1Content),
	Intelligence = makeLabel("Intelligence", tab1Content),
	MutationType = makeLabel("MutationType", tab1Content),
	PotentialEvolution = makeLabel("PotentialEvolution", tab1Content),
	HasReachedAdvancedMutation = makeLabel("AdvancedMutation", tab1Content),
	Weight = makeLabel("Weight", tab1Content),
	Health = makeLabel("Health", tab1Content),
}

-- Tab 2 labels
local tab2Labels = {
	Resilience = makeLabel("Resilience", tab2Content),
	["Max Resilience"] = makeLabel("Max Resilience", tab2Content),
	WalkSpeed = makeLabel("WalkSpeed", tab2Content),
	["Speed Difference"] = makeLabel("Speed Difference", tab2Content),
	["Region Code"] = makeLabel("Region Code", tab2Content),
	["Is Elite"] = makeLabel("Is Elite", tab2Content),
	["Current Zone"] = makeLabel("Current Zone", tab2Content),
	Credits = makeLabel("Credits", tab2Content),
	["Active Perks"] = makeLabel("Active Perks", tab2Content),
}

--------------------------
-- Footer: Bars & Styles --
--------------------------
local function ensureGradient(fill)
	for _, ch in ipairs(fill:GetChildren()) do if ch:IsA("UIGradient") then return ch end end
	local g = Instance.new("UIGradient"); g.Parent = fill; return g
end
local function barColors(kind)
	if SETTINGS.ColorblindBars then
		return PALETTE.blue1, PALETTE.blue2
	else
		if kind == "health" then
			return Color3.fromRGB(30,200,120), Color3.fromRGB(240,170,0)
		else
			return Color3.fromRGB(100,150,255), Color3.fromRGB(130,220,255)
		end
	end
end
local function styleBar(bg, fill, c1, c2)
	bg.BackgroundColor3 = PALETTE.surface
	bg.BorderSizePixel = 0
	round(bg, RADIUS-6)
	uiStroke(bg, 1, PALETTE.stroke, 0.88)
	fill.BorderSizePixel = 0
	round(fill, RADIUS-6)
	ensureGradient(fill).Color = ColorSequence.new{
		ColorSequenceKeypoint.new(0, c1),
		ColorSequenceKeypoint.new(1, c2),
	}
end
local function tweenBar(fill, pct)
	pct = math.clamp(pct, 0, 1)
	if SETTINGS.Animations then
		TweenService:Create(fill, TweenInfo.new(0.18, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
			{Size = UDim2.new(pct,0,1,0)}):Play()
	else
		fill.Size = UDim2.new(pct,0,1,0)
	end
end

-- Health row
local healthRow = Instance.new("Frame"); healthRow.BackgroundTransparency=1; healthRow.Size=UDim2.new(1,0,0,30); healthRow.Parent=footer
local healthLabel = Instance.new("TextLabel"); healthLabel.BackgroundTransparency=1; healthLabel.Size=UDim2.new(0.22,0,1,0)
healthLabel.Font=Enum.Font.GothamBold; healthLabel.TextSize=14; healthLabel.TextXAlignment=Enum.TextXAlignment.Left
healthLabel.TextColor3=PALETTE.text; healthLabel.Text="Health"; healthLabel.Parent=healthRow
local healthBarBg = Instance.new("Frame"); healthBarBg.Size=UDim2.new(0.76,0,0.56,0); healthBarBg.Position=UDim2.new(0.23,0,0.22,0); healthBarBg.Parent=healthRow
local healthBar = Instance.new("Frame"); healthBar.Size=UDim2.new(0,0,1,0); healthBar.Parent=healthBarBg
do local c1,c2=barColors("health"); styleBar(healthBarBg, healthBar, c1, c2) end

-- Resilience row
local resilRow = Instance.new("Frame"); resilRow.BackgroundTransparency=1; resilRow.Size=UDim2.new(1,0,0,30); resilRow.Parent=footer
local resilLabel = Instance.new("TextLabel"); resilLabel.BackgroundTransparency=1; resilLabel.Size=UDim2.new(0.22,0,1,0)
resilLabel.Font=Enum.Font.GothamBold; resilLabel.TextSize=14; resilLabel.TextXAlignment=Enum.TextXAlignment.Left
resilLabel.TextColor3=PALETTE.text; resilLabel.Text="Resilience"; resilLabel.Parent=resilRow
local resilienceBarBg = Instance.new("Frame"); resilienceBarBg.Size=UDim2.new(0.76,0,0.56,0); resilienceBarBg.Position=UDim2.new(0.23,0,0.22,0); resilienceBarBg.Parent=resilRow
local resilienceBar = Instance.new("Frame"); resilienceBar.Size=UDim2.new(0,0,1,0); resilienceBar.Parent=resilienceBarBg
do local c1,c2=barColors("resil"); styleBar(resilienceBarBg, resilienceBar, c1, c2) end

------------------------
-- Data / Update Logic --
------------------------
local function getCharacter(p) return p and p.Character or nil end
local function getHealth(char)
	local hum = char and char:FindFirstChildOfClass("Humanoid")
	if hum then return hum.Health, hum.MaxHealth, hum end
	return nil, nil, nil
end

local currentTarget = nil
local connections = {}
local function disconnectAll()
	for _, c in ipairs(connections) do pcall(function() c:Disconnect() end) end
	table.clear(connections)
end

local function updateTab1(target)
	local char = getCharacter(target)
	if not char then
		for _, lbl in pairs(tab1Labels) do lbl.Text = "[NO DATA]" end
		healthBar.Size = UDim2.new(0,0,1,0)
		return
	end
	local function getCharAttr(n) return char:GetAttribute(n) or "N/A" end
	local function getPlayerAttr(n) return target:GetAttribute(n) or "N/A" end

	local h, mh = getHealth(char)
	tab1Labels.Subject.Text = "Subject: " .. target.Name
	tab1Labels.Exposure.Text = "Exposure: " .. tostring(getCharAttr("Exposure"))
	tab1Labels.Strength.Text = "Strength: " .. tostring(getCharAttr("StrengthAttribute"))
	tab1Labels.Agility.Text = "Agility: " .. tostring(getCharAttr("AgilityAttribute"))
	tab1Labels.Intelligence.Text = "Intelligence: " .. tostring(getCharAttr("IntelligenceAttribute"))
	tab1Labels.MutationType.Text = "MutationType: " .. tostring(getCharAttr("MutationType"))
	tab1Labels.PotentialEvolution.Text = "PotentialEvolution: " .. tostring(getCharAttr("PotentialEvolution"))
	tab1Labels.HasReachedAdvancedMutation.Text = "AdvancedMutation: " .. tostring(getCharAttr("HasReachedAdvancedMutation"))

	local weight = getPlayerAttr("Weight")
	local wNum = tonumber(weight)
	local wText = "Weight: " .. tostring(weight) .. (wNum and " kg" or "")
	if wNum then
		local cls, col = "", Color3.fromRGB(200,255,200)
		if math.abs(wNum - 77.2) < 1e-6 then cls=" [PERFECT]"; col=Color3.fromRGB(255,215,0)
		elseif wNum >= 60 and wNum < 80 then cls=" [Average]"; col=Color3.fromRGB(100,255,100)
		elseif wNum >= 80 and wNum <= 120 then cls=" [Overweight]"; col=Color3.fromRGB(255,150,100)
		elseif wNum >= 50 and wNum < 60 then cls=" [Underweight]"; col=Color3.fromRGB(150,200,255)
		else cls=" [Out of Range]"; col=Color3.fromRGB(255,100,100) end
		wText ..= cls; tab1Labels.Weight.TextColor3 = col
	else
		tab1Labels.Weight.TextColor3 = Color3.fromRGB(200,255,200)
	end
	tab1Labels.Weight.Text = wText

	if h and mh and mh > 0 then
		tab1Labels.Health.Text = string.format("Health: %d / %d", math.floor(h), math.floor(mh))
		tweenBar(healthBar, h/mh)
	else
		tab1Labels.Health.Text = "Health: N/A"
		healthBar.Size = UDim2.new(0,0,1,0)
	end
end

local function updateTab2(target)
	local char = getCharacter(target)
	if not char then
		for _, lbl in pairs(tab2Labels) do lbl.Text = "[NO DATA]" end
		resilienceBar.Size = UDim2.new(0,0,1,0)
		return
	end
	local function getCharAttr(n) return char:GetAttribute(n) end
	local function getPlayerAttr(n) return target:GetAttribute(n) end

	local r = getPlayerAttr("Resilience") or getCharAttr("Resilience") or "N/A"
	local mr = getPlayerAttr("MaxResilience") or getCharAttr("MaxResilience") or "N/A"
	tab2Labels.Resilience.Text = "Resilience: " .. tostring(r)
	tab2Labels["Max Resilience"].Text = "Max Resilience: " .. tostring(mr)
	if typeof(r)=="number" and typeof(mr)=="number" and mr>0 then
		tweenBar(resilienceBar, r/mr)
	else
		resilienceBar.Size = UDim2.new(0,0,1,0)
	end

	local hum = char:FindFirstChildOfClass("Humanoid")
	if hum then
		local currentSpeed = hum.WalkSpeed
		local d, rr = SETTINGS.DefaultSpeed, SETTINGS.RunSpeed
		local diff = currentSpeed - d
		local diffText = (diff >= 0) and ("+"..string.format("%.1f", diff)) or string.format("%.1f", diff)
		tab2Labels.WalkSpeed.Text = string.format("WalkSpeed: %.1f", currentSpeed)
		tab2Labels["Speed Difference"].Text = string.format("Speed Difference: %s (Default: %g | Run: %g)", diffText, d, rr)
	else
		tab2Labels.WalkSpeed.Text = "WalkSpeed: N/A"
		tab2Labels["Speed Difference"].Text = "Speed Difference: N/A"
	end

	tab2Labels["Region Code"].Text = "Region Code: " .. tostring(getPlayerAttr("RegionCode") or getCharAttr("RegionCode") or "N/A")
	tab2Labels["Is Elite"].Text    = "Is Elite: " .. tostring(getPlayerAttr("IsElite") or getCharAttr("IsElite") or "N/A")
	tab2Labels["Current Zone"].Text= "Current Zone: " .. tostring(getPlayerAttr("CurrentZone") or getCharAttr("CurrentZone") or "N/A")

	local dataFolder = target:FindFirstChild("Data")
	local credits = "N/A"
	if dataFolder then
		local creditsValue = dataFolder:FindFirstChild("Credits")
		if creditsValue and typeof(creditsValue.Value) == "number" then
			local amount = math.floor(creditsValue.Value)
			credits = tostring(amount):reverse():gsub("(%d%d%d)", "%1,"):reverse():gsub("^,", "")
		end
	end
	tab2Labels.Credits.Text = "Credits: " .. credits

	local activePerks = {}
	if dataFolder then
		for _, child in ipairs(dataFolder:GetChildren()) do
			if (child:IsA("BoolValue") and child.Value) or (child:IsA("IntValue") and child.Value>0 and child.Name:lower():find("perk")) then
				table.insert(activePerks, child.Name)
			end
		end
	end
	tab2Labels["Active Perks"].Text = (#activePerks>0) and ("Active Perks: " .. table.concat(activePerks, ", ")) or "Active Perks: None"
end

local function refreshAll()
	if not currentTarget then
		for _, l in pairs(tab1Labels) do l.Text="[NO DATA]" end
		for _, l in pairs(tab2Labels) do l.Text="[NO DATA]" end
		healthBar.Size = UDim2.new(0,0,1,0); resilienceBar.Size = UDim2.new(0,0,1,0)
		return
	end
	updateTab1(currentTarget); updateTab2(currentTarget)
end

function rewireForTarget(target)
	if currentTarget == target then return end
	currentTarget = target
	for _, l in pairs(tab1Labels) do l.Text = "[Updating...]" end
	for _, l in pairs(tab2Labels) do l.Text = "[Updating...]" end
	disconnectAll()
	if not target then refreshAll(); return end
	refreshAll()

	-- Bind humanoid signals
	local function bindHumanoidSignals()
		local char = getCharacter(target)
		local hum = char and char:FindFirstChildOfClass("Humanoid")
		if hum then
			table.insert(connections, hum.HealthChanged:Connect(function() updateTab1(target) end))
			table.insert(connections, hum:GetPropertyChangedSignal("MaxHealth"):Connect(function() updateTab1(target) end))
			table.insert(connections, hum:GetPropertyChangedSignal("WalkSpeed"):Connect(function() updateTab2(target) end))
		end
	end
	table.insert(connections, target.CharacterAdded:Connect(function()
		task.defer(refreshAll)
		task.delay(0.05, bindHumanoidSignals)
	end))
	bindHumanoidSignals()

	-- Attributes on player/char
	table.insert(connections, target.AttributeChanged:Connect(function() updateTab1(target); updateTab2(target) end))
	local c = getCharacter(target)
	if c then table.insert(connections, c.AttributeChanged:Connect(function() updateTab1(target); updateTab2(target) end)) end

	-- Data folder
	local dataFolder = target:FindFirstChild("Data")
	if dataFolder then
		table.insert(connections, dataFolder.ChildAdded:Connect(function() updateTab2(target) end))
		table.insert(connections, dataFolder.ChildRemoved:Connect(function() updateTab2(target) end))
		for _, child in ipairs(dataFolder:GetChildren()) do
			table.insert(connections, child.Changed:Connect(function() updateTab2(target) end))
		end
	end
end

-- Target from box
local function resolveTarget()
	local t = targetBox.Text
	return (t == "" and LocalPlayer) or Players:FindFirstChild(t)
end
local function applyBoxTarget()
	rewireForTarget(resolveTarget())
end
targetBox.FocusLost:Connect(function(enter) if enter then applyBoxTarget() end end)
targetBox.FocusLost:Connect(function() applyBoxTarget() end)

-- Default target = self
rewireForTarget(LocalPlayer)

-------------------
-- Settings Panel --
-------------------
local settingsPanel = Instance.new("Frame")
settingsPanel.Visible = false
settingsPanel.ZIndex = 30
settingsPanel.Size = UDim2.new(0, 260, 0, 260)
settingsPanel.Position = UDim2.new(1, -270, 0, TITLE_H + 8)
settingsPanel.BackgroundColor3 = PALETTE.surface2
settingsPanel.Parent = frame
round(settingsPanel, RADIUS-2)
uiStroke(settingsPanel, 1, PALETTE.stroke, 0.85)

local spPad = Instance.new("UIPadding", settingsPanel)
spPad.PaddingTop = UDim.new(0, 8); spPad.PaddingLeft=UDim.new(0,8); spPad.PaddingRight=UDim.new(0,8); spPad.PaddingBottom=UDim.new(0,8)
local spList = Instance.new("UIListLayout", settingsPanel)
spList.FillDirection = Enum.FillDirection.Vertical
spList.Padding = UDim.new(0, 6)

local function addRowH(h)
	local row = Instance.new("Frame"); row.BackgroundTransparency=1; row.Size=UDim2.new(1,0,0,h); row.Parent=settingsPanel; return row
end
local function makeToggle(label, getFn, setFn)
	local row = addRowH(28)
	local txt = Instance.new("TextLabel")
	txt.BackgroundTransparency=1; txt.TextXAlignment=Enum.TextXAlignment.Left; txt.Font=Enum.Font.Gotham; txt.TextSize=14; txt.TextColor3=PALETTE.text
	txt.Text=label; txt.Size=UDim2.new(1,-44,1,0); txt.Parent=row
	local btn = Instance.new("TextButton")
	btn.Size=UDim2.new(0,36,0,22); btn.Position=UDim2.new(1,-40,0.5,-11)
	btn.Text = getFn() and "ON" or "OFF"; btn.Font=Enum.Font.GothamBold; btn.TextSize=12; btn.TextColor3=PALETTE.text
	btn.BackgroundColor3 = getFn() and PALETTE.accent or PALETTE.surface; btn.BorderSizePixel=0; btn.Parent=row
	round(btn, 10)
	btn.MouseButton1Click:Connect(function()
		local v = not getFn(); setFn(v)
		btn.Text = v and "ON" or "OFF"; btn.BackgroundColor3 = v and PALETTE.accent or PALETTE.surface
		notify(label .. ": " .. (v and "ON" or "OFF"), PALETTE.textSubtle)
	end)
end
local function makeNumber(label, getter, setter)
	local row = addRowH(28)
	local txt = Instance.new("TextLabel")
	txt.BackgroundTransparency=1; txt.TextXAlignment=Enum.TextXAlignment.Left; txt.Font=Enum.Font.Gotham; txt.TextSize=14; txt.TextColor3=PALETTE.text
	txt.Text=label; txt.Size=UDim2.new(1,-80,1,0); txt.Parent=row
	local boxNum = Instance.new("TextBox")
	boxNum.Size=UDim2.new(0,70,0,22); boxNum.Position=UDim2.new(1,-74,0.5,-11)
	boxNum.BackgroundColor3=PALETTE.surface; boxNum.TextColor3=PALETTE.text; boxNum.Font=Enum.Font.Gotham; boxNum.TextSize=14
	boxNum.ClearTextOnFocus=false; boxNum.Text=tostring(getter()); boxNum.Parent=row
	round(boxNum, 8); uiStroke(boxNum, 1, PALETTE.stroke, 0.88)
	boxNum.FocusLost:Connect(function()
		local v = tonumber(boxNum.Text)
		if v then setter(v) end
		boxNum.Text = tostring(getter())
		notify(label .. ": " .. boxNum.Text, PALETTE.textSubtle)
	end)
end

-- Build settings
makeToggle("Animations", function() return SETTINGS.Animations end, function(v) SETTINGS.Animations=v end)
makeToggle("Compact Mode", function() return SETTINGS.CompactMode end, function(v)
	SETTINGS.CompactMode=v
	for _, lbl in pairs(tab1Labels) do lbl.TextSize = v and 14 or 16; lbl.Size = UDim2.new(1,0,0,v and 20 or 22) end
	for _, lbl in pairs(tab2Labels) do lbl.TextSize = v and 14 or 16; lbl.Size = UDim2.new(1,0,0,v and 20 or 22) end
	targetBox.TextSize = v and 14 or 16
end)
makeToggle("Colorblind Bars", function() return SETTINGS.ColorblindBars end, function(v)
	SETTINGS.ColorblindBars = v
	local h1,h2 = barColors("health"); ensureGradient(healthBar).Color = ColorSequence.new{ ColorSequenceKeypoint.new(0,h1), ColorSequenceKeypoint.new(1,h2) }
	local r1,r2 = barColors("resil");  ensureGradient(resilienceBar).Color = ColorSequence.new{ ColorSequenceKeypoint.new(0,r1), ColorSequenceKeypoint.new(1,r2) }
	refreshAll()
end)
makeToggle("Shadow", function() return SETTINGS.ShadowEnabled end, function(v)
	SETTINGS.ShadowEnabled = v
	-- (Optional: add drop shadow image here if you want a 9-slice asset)
end)
makeNumber("Default Speed", function() return SETTINGS.DefaultSpeed end, function(n) SETTINGS.DefaultSpeed=n; if currentTarget then updateTab2(currentTarget) end end)
makeNumber("Run Speed",     function() return SETTINGS.RunSpeed end,     function(n) SETTINGS.RunSpeed=n; if currentTarget then updateTab2(currentTarget) end end)
makeNumber("Safety Refresh (s)", function() return SETTINGS.SafetyRefreshSeconds end, function(n) SETTINGS.SafetyRefreshSeconds = math.max(0,n) end)

settingsBtn.MouseButton1Click:Connect(function()
	settingsPanel.Visible = not settingsPanel.Visible
end)

-----------------------------
-- Drag + Resize (Clamped) --
-----------------------------
do
	local dragging=false; local dragInput; local mousePos; local framePos
	titleBar.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging=true; mousePos=input.Position; framePos=frame.Position
			input.Changed:Connect(function() if input.UserInputState==Enum.UserInputState.End then dragging=false end end)
		end
	end)
	titleBar.InputChanged:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseMovement then dragInput=input end end)
	UserInputService.InputChanged:Connect(function(input)
		if input==dragInput and dragging then
			local d = input.Position - mousePos
			frame.Position = UDim2.new(framePos.X.Scale, framePos.X.Offset + d.X, framePos.Y.Scale, framePos.Y.Offset + d.Y)
		end
	end)

	local resizing=false; local resizeStart; local sizeStart
	local resizeHandle = Instance.new("TextButton")
	resizeHandle.Size=UDim2.new(0,20,0,20); resizeHandle.Position=UDim2.new(1,-24,1,-24)
	resizeHandle.Text="‚ã∞"; resizeHandle.Font=Enum.Font.GothamBold; resizeHandle.TextSize=16
	resizeHandle.TextColor3=PALETTE.text; resizeHandle.BackgroundTransparency=1; resizeHandle.ZIndex=5; resizeHandle.Parent=frame
	resizeHandle.InputBegan:Connect(function(input)
		if input.UserInputType==Enum.UserInputType.MouseButton1 then
			resizing=true; resizeStart=input.Position; sizeStart=frame.Size
			input.Changed:Connect(function() if input.UserInputState==Enum.UserInputState.End then resizing=false end end)
		end
	end)
	UserInputService.InputChanged:Connect(function(input)
		if input.UserInputType==Enum.UserInputType.MouseMovement and resizing then
			local d = input.Position - resizeStart
			local w = math.clamp(sizeStart.X.Offset + d.X, MIN_W, MAX_W)
			local h = math.clamp(sizeStart.Y.Offset + d.Y, MIN_H, MAX_H)
			frame.Size = UDim2.new(0, w, 0, h)
			if not collapsed then savedSize = frame.Size end
		end
	end)
end

------------------------------
-- Keybind: Toggle whole GUI --
------------------------------
UserInputService.InputBegan:Connect(function(input, gpe)
	if gpe then return end
	if input.KeyCode == Enum.KeyCode.P then
		gui.Enabled = not gui.Enabled
	end
end)

----------------------------------------
-- HP Alert / Leave / Rejoin System  ---
----------------------------------------
-- UI: subtle red alert banner that fades
local hpAlert = Instance.new("TextLabel")
hpAlert.BackgroundColor3 = Color3.fromRGB(90, 20, 20)
hpAlert.TextColor3 = Color3.fromRGB(255, 220, 220)
hpAlert.Font = Enum.Font.GothamBold
hpAlert.TextSize = 14
hpAlert.TextWrapped = true
hpAlert.Visible = false
hpAlert.ZIndex = 55
hpAlert.Size = UDim2.new(0, 360, 0, 28)
hpAlert.AnchorPoint = Vector2.new(0.5, 0)
hpAlert.Position = UDim2.new(0.5, 0, 0, TITLE_H + 6)
hpAlert.Parent = frame
round(hpAlert, 8)
uiStroke(hpAlert, 1, PALETTE.danger, 0.25)

-- Button visual states
local function setHPBtnVisual()
	-- color by mode; dim if disabled
	local base =
		(HPState.Mode == "ALERT" and PALETTE.warn) or
		(HPState.Mode == "LEAVE" and PALETTE.danger) or
		(HPState.Mode == "REJOIN" and PALETTE.accentHi) or
		PALETTE.text
	hpBtn.TextColor3 = HPState.Enabled and base or PALETTE.textSubtle
end
setHPBtnVisual()

-- Cycle mode on right-click (MouseButton2Click)
hpBtn.MouseButton2Click:Connect(function()
	if HPState.Mode == "ALERT" then
		HPState.Mode = "LEAVE"
	elseif HPState.Mode == "LEAVE" then
		HPState.Mode = "REJOIN"
	else
		HPState.Mode = "ALERT"
	end
	setHPBtnVisual()
	notify("HP mode: " .. HPState.Mode, PALETTE.textSubtle)
end)

-- Enable/disable on left click
hpBtn.MouseButton1Click:Connect(function()
	HPState.Enabled = not HPState.Enabled
	setHPBtnVisual()
	notify("HP system " .. (HPState.Enabled and "ENABLED" or "DISABLED"), PALETTE.textSubtle)
end)

-- HealthChanged wiring (no loops). Tracks delta.
local lastHealth = nil
local humConn -- current humanoid connection

local function disconnectHumanoid()
	if humConn then
		pcall(function() humConn:Disconnect() end)
		humConn = nil
	end
end

local function bindLocalHumanoid()
	disconnectHumanoid()
	local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
	local hum = char:FindFirstChildOfClass("Humanoid")
	if not hum then
		char.ChildAdded:Wait()
		hum = char:FindFirstChildOfClass("Humanoid")
	end
	lastHealth = hum and hum.Health or nil

	if hum then
		humConn = hum.HealthChanged:Connect(function(newH)
			if not HPState.Enabled then
				lastHealth = newH
				return
			end
			local old = lastHealth or newH
			lastHealth = newH
			local drop = math.max(0, old - newH)
			if drop <= 0 then return end

			if HPState.Mode == "ALERT" then
				-- show banner briefly
				hpAlert.Text = ("‚ö† HP LOSS DETECTED ‚Äî Lost %d HP | Current: %d"):format(math.floor(drop), math.floor(newH))
				hpAlert.Visible = true
				hpAlert.BackgroundTransparency = 0
				hpAlert.TextTransparency = 0
				if SETTINGS.Animations then
					local t = TweenService:Create(hpAlert, TweenInfo.new(0.15), {BackgroundTransparency = 0, TextTransparency = 0})
					t:Play()
				end
				task.delay(2.0, function()
					if hpAlert and hpAlert.Visible then
						if SETTINGS.Animations then
							local t2 = TweenService:Create(hpAlert, TweenInfo.new(0.25), {BackgroundTransparency = 1, TextTransparency = 1})
							t2:Play(); t2.Completed:Wait()
						end
						hpAlert.Visible = false
					end
				end)
				notify(("HP -%d (now %d)"):format(math.floor(drop), math.floor(newH)), PALETTE.warn)

			elseif HPState.Mode == "LEAVE" then
				notify("HP drop detected ‚Äî disconnecting...", PALETTE.danger)
				pcall(function()
					LocalPlayer:Kick("Disconnected by HP Alert")
				end)

			elseif HPState.Mode == "REJOIN" then
				notify("HP drop detected ‚Äî rejoining...", PALETTE.accentHi)
				task.delay(0.4, function()
					pcall(function()
						TeleportService:Teleport(game.PlaceId, LocalPlayer)
					end)
				end)
			end
		end)
	end
end

-- Bind on spawn
LocalPlayer.CharacterAdded:Connect(function()
	task.defer(bindLocalHumanoid)
end)
-- If already spawned
if LocalPlayer.Character then
	bindLocalHumanoid()
else
	LocalPlayer.CharacterAdded:Wait()
	bindLocalHumanoid()
end
