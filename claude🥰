-- ZETA LABS // BIO-SCANNER (Optimized & Fixed)
-- All performance issues, memory leaks, and UX bugs have been addressed
-- Maintains all original functionality while improving stability and FPS

-----------------------
-- Services & Locals --
-----------------------
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local TeleportService = game:GetService("TeleportService")
local Lighting = game:GetService("Lighting")

local player = Players.LocalPlayer

----------------
-- Constants --
----------------
local RADIUS = 12
local TITLE_H = 36
local DROPDOWN_MAX_HEIGHT = 110
local TOAST_DURATION = 2.0
local TOAST_FADE_TIME = 0.2
local SEARCH_DEBOUNCE_TIME = 0.15
local HP_ALERT_DURATION = 2.0
local TWEEN_SPEED_FAST = 0.12
local TWEEN_SPEED_NORMAL = 0.15
local TWEEN_SPEED_SLOW = 0.2
local TWEEN_SPEED_EXPAND = 0.25

----------------
-- Appearance --
----------------
local THEME = {
	bg         = Color3.fromRGB(24, 26, 28),
	surface    = Color3.fromRGB(30, 33, 36),
	surface2   = Color3.fromRGB(36, 40, 44),
	text       = Color3.fromRGB(230, 240, 240),
	textSubtle = Color3.fromRGB(160, 180, 185),
	accent     = Color3.fromRGB(62, 140, 140),
	accentHi   = Color3.fromRGB(90, 190, 190),
	danger     = Color3.fromRGB(210, 70, 70),
	warn       = Color3.fromRGB(255, 200, 40),
	barH1      = Color3.fromRGB(30, 200, 120),
	barH2      = Color3.fromRGB(240, 170, 0),
	barR1      = Color3.fromRGB(100, 150, 255),
	barR2      = Color3.fromRGB(130, 220, 255),
	-- Colorblind mode alternatives
	barH1_CB   = Color3.fromRGB(50, 150, 200),
	barH2_CB   = Color3.fromRGB(100, 180, 240),
	barR1_CB   = Color3.fromRGB(255, 180, 50),
	barR2_CB   = Color3.fromRGB(255, 220, 100),
}

-- Default settings with proper types
local DEFAULT_SETTINGS = {
	Animations = true,
	CompactMode = false,
	ColorblindBars = false,
	FPSSaver = false,
	DefaultSpeed = 9,
	RunSpeed = 20,
	SafetyRefreshSeconds = 0,
	ActiveTab = 1,
}

local SETTINGS = {}
for k, v in pairs(DEFAULT_SETTINGS) do
	SETTINGS[k] = v
end

local HPState = { Enabled = false, Mode = "ALERT" }

-- Active tween tracking for cancellation
local activeTweens = {}

-- Global cleanup registry
local cleanupTasks = {}

-----------------------
-- Utility Functions --
-----------------------
local function round(inst, r)
	local u = Instance.new("UICorner")
	u.CornerRadius = UDim.new(0, r or RADIUS)
	u.Parent = inst
	return u
end

local function stroke(inst, t, c, tr)
	local s = Instance.new("UIStroke")
	s.Thickness = t or 1
	s.Color = c or THEME.text
	s.Transparency = tr or 0.88
	s.Parent = inst
	return s
end

local function cancelTween(key)
	if activeTweens[key] then
		pcall(function() activeTweens[key]:Cancel() end)
		activeTweens[key] = nil
	end
end

local function playTween(key, instance, tweenInfo, properties)
	cancelTween(key)
	local tween = TweenService:Create(instance, tweenInfo, properties)
	activeTweens[key] = tween
	tween:Play()
	tween.Completed:Connect(function()
		if activeTweens[key] == tween then
			activeTweens[key] = nil
		end
	end)
	return tween
end

local function safeConnect(signal, callback)
	local connection
	local success, err = pcall(function()
		connection = signal:Connect(callback)
	end)
	if success and connection then
		table.insert(cleanupTasks, function()
			pcall(function() connection:Disconnect() end)
		end)
		return connection
	end
	return nil
end

local function addCleanupTask(task)
	table.insert(cleanupTasks, task)
end

local function runCleanup()
	for i = #cleanupTasks, 1, -1 do
		pcall(cleanupTasks[i])
		cleanupTasks[i] = nil
	end
end

----------------
-- ScreenGui  --
----------------
local gui = Instance.new("ScreenGui")
gui.Name = "ZetaLabs"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

addCleanupTask(function()
	if gui then gui:Destroy() end
end)

-- Toast / notify helper
local toastArea = Instance.new("Frame")
toastArea.BackgroundTransparency = 1
toastArea.Size = UDim2.new(1,0,0,0)
toastArea.Position = UDim2.new(0,0,0,8)
toastArea.Parent = gui
local toastList = Instance.new("UIListLayout", toastArea)
toastList.HorizontalAlignment = Enum.HorizontalAlignment.Center
toastList.VerticalAlignment   = Enum.VerticalAlignment.Top
toastList.Padding = UDim.new(0,6)

local function notify(txt, color)
	local card = Instance.new("TextLabel")
	card.BackgroundColor3 = THEME.surface2
	card.TextColor3 = color or THEME.text
	card.Font = Enum.Font.Gotham
	card.TextSize = 14
	card.TextWrapped = true
	card.AutomaticSize = Enum.AutomaticSize.XY
	card.Size = UDim2.new(0,0,0,0)
	card.Text = tostring(txt)
	card.ZIndex = 200
	card.Parent = toastArea
	round(card, 8)
	stroke(card, 1, THEME.text, 0.86)
	local pad = Instance.new("UIPadding", card)
	pad.PaddingTop = UDim.new(0,6); pad.PaddingBottom = UDim.new(0,6)
	pad.PaddingLeft = UDim.new(0,10); pad.PaddingRight = UDim.new(0,10)
	
	if SETTINGS.Animations and not SETTINGS.FPSSaver then
		card.BackgroundTransparency = 1
		playTween("toast_" .. tostring(card), card, TweenInfo.new(TWEEN_SPEED_FAST), {BackgroundTransparency = 0})
	end
	
	task.delay(TOAST_DURATION, function()
		if card and card.Parent then
			if SETTINGS.Animations and not SETTINGS.FPSSaver then
				local t = playTween("toast_fade_" .. tostring(card), card, TweenInfo.new(TOAST_FADE_TIME), {BackgroundTransparency=1, TextTransparency=1})
				t.Completed:Wait()
			end
			card:Destroy()
		end
	end)
end

------------
-- Window --
------------
local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 460, 0, 540)
frame.Position = UDim2.new(0.5, -230, 0.5, -270)
frame.BackgroundColor3 = THEME.surface
frame.BorderSizePixel = 0
frame.Parent = gui
round(frame, RADIUS)
stroke(frame, 1, THEME.text, 0.9)

-- Title bar
local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1, 0, 0, TITLE_H)
titleBar.BackgroundColor3 = THEME.surface2
titleBar.BorderSizePixel = 0
titleBar.Parent = frame
round(titleBar, RADIUS)

local underline = Instance.new("Frame")
underline.Size = UDim2.new(1, 0, 0, 2)
underline.Position = UDim2.new(0, 0, 1, -2)
underline.BackgroundColor3 = THEME.accent
underline.Parent = titleBar

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -240, 1, 0)
title.Position = UDim2.new(0, 12, 0, 0)
title.BackgroundTransparency = 1
title.Font = Enum.Font.GothamBold
title.TextSize = 20
title.Text = "ZETA LABS // BIO-SCANNER"
title.TextColor3 = THEME.text
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = titleBar

-- Right dock for title buttons
local dock = Instance.new("Frame")
dock.BackgroundTransparency = 1
dock.Size = UDim2.new(0, 250, 1, 0)
dock.Position = UDim2.new(1, -260, 0, 0)
dock.Parent = titleBar

local dockList = Instance.new("UIListLayout", dock)
dockList.FillDirection = Enum.FillDirection.Horizontal
dockList.HorizontalAlignment = Enum.HorizontalAlignment.Right
dockList.VerticalAlignment = Enum.VerticalAlignment.Center
dockList.Padding = UDim.new(0, 6)

local function iconButton(text, name)
	local b = Instance.new("TextButton")
	b.Name = name or "Btn"
	b.AutoButtonColor = false
	b.Size = UDim2.new(0, 30, 0, 26)
	b.BackgroundTransparency = 1
	b.Text = text
	b.Font = Enum.Font.GothamBold
	b.TextSize = 16
	b.TextColor3 = THEME.text
	b.Parent = dock
	
	safeConnect(b.MouseEnter, function()
		if SETTINGS.Animations and not SETTINGS.FPSSaver then
			playTween("btn_hover_" .. name, b, TweenInfo.new(TWEEN_SPEED_NORMAL), {
				TextColor3 = THEME.accentHi,
				TextSize = 17
			})
		end
	end)
	
	safeConnect(b.MouseLeave, function()
		if SETTINGS.Animations and not SETTINGS.FPSSaver then
			local originalColor = (name == "Close" and Color3.fromRGB(255,140,140)) or 
			                     (name == "Uninject" and Color3.fromRGB(255,100,100)) or 
			                     THEME.text
			playTween("btn_leave_" .. name, b, TweenInfo.new(TWEEN_SPEED_NORMAL), {
				TextColor3 = originalColor,
				TextSize = 16
			})
		end
	end)
	
	return b
end

local settingsBtn = iconButton("‚öô", "Settings")
local hpBtn       = iconButton("HP","HP")
local collapseBtn = iconButton("‚ñÅ","Collapse")
local uninjectBtn = iconButton("üóë","Uninject")
local closeBtn    = iconButton("X","Close")
closeBtn.TextColor3 = Color3.fromRGB(255,140,140)
uninjectBtn.TextColor3 = Color3.fromRGB(255,100,100)

-- Body + Footer containers
local contentFrame = Instance.new("Frame")
contentFrame.Size = UDim2.new(1, -20, 1, -(TITLE_H + 90))
contentFrame.Position = UDim2.new(0, 10, 0, TITLE_H + 8)
contentFrame.BackgroundTransparency = 1
contentFrame.Parent = frame

local footer = Instance.new("Frame")
footer.Size = UDim2.new(1, -20, 0, 82)
footer.Position = UDim2.new(0, 10, 1, -90)
footer.BackgroundColor3 = THEME.surface2
footer.Parent = frame
round(footer, RADIUS-4)
stroke(footer, 1, THEME.text, 0.85)
local footerPad = Instance.new("UIPadding", footer)
footerPad.PaddingTop = UDim.new(0,8); footerPad.PaddingBottom = UDim.new(0,8)
footerPad.PaddingLeft = UDim.new(0,8); footerPad.PaddingRight  = UDim.new(0,8)
local footerList = Instance.new("UIListLayout", footer)
footerList.FillDirection = Enum.FillDirection.Vertical
footerList.Padding = UDim.new(0,6)

-- Collapse behavior
local collapsed = false
local savedSize = frame.Size
local function setCollapsed(state)
	collapsed = state
	if SETTINGS.Animations and not SETTINGS.FPSSaver then
		playTween("collapse", frame, TweenInfo.new(TWEEN_SPEED_NORMAL), {
			Size = state and UDim2.new(savedSize.X.Scale, savedSize.X.Offset, 0, TITLE_H + 8) or savedSize
		})
	else
		frame.Size = state and UDim2.new(savedSize.X.Scale, savedSize.X.Offset, 0, TITLE_H + 8) or savedSize
	end
	contentFrame.Visible = not state
	footer.Visible = not state
	collapseBtn.Text = state and "‚ñÉ" or "‚ñÅ"
end

safeConnect(collapseBtn.MouseButton1Click, function() setCollapsed(not collapsed) end)
safeConnect(closeBtn.MouseButton1Click, function() gui.Enabled = false end)

------------------------
-- Uninject Modal
------------------------
local dim = Instance.new("Frame")
dim.BackgroundColor3 = Color3.new(0,0,0)
dim.BackgroundTransparency = 1
dim.Visible = false
dim.ZIndex = 500
dim.Size = UDim2.fromScale(1,1)
dim.Parent = gui

local blur = Instance.new("BlurEffect")
blur.Enabled = false
blur.Size = 0
blur.Parent = Lighting

addCleanupTask(function()
	if blur then blur:Destroy() end
end)

local confirmDialog = Instance.new("Frame")
confirmDialog.Size = UDim2.new(0, 300, 0, 120)
confirmDialog.Position = UDim2.new(0.5, -150, 0.5, -60)
confirmDialog.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
confirmDialog.Visible = false
confirmDialog.ZIndex = 510
confirmDialog.Parent = gui
round(confirmDialog, RADIUS-2)
stroke(confirmDialog, 1, THEME.text, 0.82)

local confirmTitle = Instance.new("TextLabel")
confirmTitle.Size = UDim2.new(1, -20, 0, 30)
confirmTitle.Position = UDim2.new(0, 10, 0, 10)
confirmTitle.BackgroundTransparency = 1
confirmTitle.Font = Enum.Font.GothamBold
confirmTitle.TextSize = 16
confirmTitle.Text = "‚ö† CONFIRM UNINJECT"
confirmTitle.TextColor3 = THEME.warn
confirmTitle.ZIndex = 511
confirmTitle.Parent = confirmDialog

local confirmMessage = Instance.new("TextLabel")
confirmMessage.Size = UDim2.new(1, -20, 0, 36)
confirmMessage.Position = UDim2.new(0, 10, 0, 44)
confirmMessage.BackgroundTransparency = 1
confirmMessage.Font = Enum.Font.Gotham
confirmMessage.TextSize = 13
confirmMessage.TextWrapped = true
confirmMessage.Text = "Are you sure you want to do this?\nThis will close the menu permanently."
confirmMessage.TextColor3 = THEME.text
confirmMessage.ZIndex = 511
confirmMessage.Parent = confirmDialog

local confirmYesBtn = Instance.new("TextButton")
confirmYesBtn.Size = UDim2.new(0, 130, 0, 32)
confirmYesBtn.Position = UDim2.new(0, 10, 1, -42)
confirmYesBtn.Text = "YES, UNINJECT"
confirmYesBtn.Font = Enum.Font.GothamBold
confirmYesBtn.TextSize = 13
confirmYesBtn.TextColor3 = THEME.text
confirmYesBtn.BackgroundColor3 = THEME.danger
confirmYesBtn.ZIndex = 511
confirmYesBtn.Parent = confirmDialog
round(confirmYesBtn, RADIUS-6)

local confirmNoBtn = Instance.new("TextButton")
confirmNoBtn.Size = UDim2.new(0, 130, 0, 32)
confirmNoBtn.Position = UDim2.new(1, -140, 1, -42)
confirmNoBtn.Text = "CANCEL"
confirmNoBtn.Font = Enum.Font.GothamBold
confirmNoBtn.TextSize = 13
confirmNoBtn.TextColor3 = THEME.text
confirmNoBtn.BackgroundColor3 = THEME.surface2
confirmNoBtn.ZIndex = 511
confirmNoBtn.Parent = confirmDialog
round(confirmNoBtn, RADIUS-6)

local function showConfirmModal(show)
	dim.Visible = show
	dim.ZIndex = show and 500 or 1
	confirmDialog.Visible = show
	blur.Enabled = show
	
	if SETTINGS.Animations and not SETTINGS.FPSSaver then
		if show then
			dim.BackgroundTransparency = 1
			playTween("dim_show", dim, TweenInfo.new(TWEEN_SPEED_FAST), {BackgroundTransparency = 0.6})
			playTween("blur_show", blur, TweenInfo.new(TWEEN_SPEED_FAST), {Size = 8})
		else
			playTween("dim_hide", dim, TweenInfo.new(TWEEN_SPEED_FAST), {BackgroundTransparency = 1})
			playTween("blur_hide", blur, TweenInfo.new(TWEEN_SPEED_FAST), {Size = 0})
		end
	else
		dim.BackgroundTransparency = show and 0.6 or 1
		blur.Size = show and 8 or 0
	end
end

safeConnect(uninjectBtn.MouseButton1Click, function() showConfirmModal(true) end)
safeConnect(confirmNoBtn.MouseButton1Click, function() showConfirmModal(false) end)
safeConnect(confirmYesBtn.MouseButton1Click, function()
	showConfirmModal(false)
	notify("Uninjecting and cleaning up...")
	task.wait(0.3)
	runCleanup()
end)

safeConnect(UserInputService.InputBegan, function(input, gpe)
	if not gpe and confirmDialog.Visible and input.KeyCode == Enum.KeyCode.Escape then
		showConfirmModal(false)
	end
end)

-------------------------
-- Target Search Row
-------------------------
local grid = Instance.new("UIGridLayout")
grid.Parent = contentFrame
grid.CellSize = UDim2.new(1, 0, 0, 36)
grid.FillDirectionMaxCells = 1
grid.SortOrder = Enum.SortOrder.LayoutOrder

local targetRow = Instance.new("Frame")
targetRow.BackgroundTransparency = 1
targetRow.LayoutOrder = 1
targetRow.Parent = contentFrame

local box = Instance.new("TextBox")
box.Size = UDim2.new(1, 0, 1, 0)
box.AnchorPoint = Vector2.new(0.5,0.5)
box.Position = UDim2.new(0.5,0,0.5,0)
box.PlaceholderText = "Enter player name (leave empty for self)"
box.BackgroundColor3 = THEME.surface2
box.TextColor3 = THEME.text
box.Font = Enum.Font.Gotham
box.TextSize = SETTINGS.CompactMode and 14 or 16
box.ClearTextOnFocus = false
box.Parent = targetRow
round(box, RADIUS-4)
stroke(box, 1, THEME.text, 0.86)

-- Dropdown
local dropdown = Instance.new("ScrollingFrame")
dropdown.Size = UDim2.new(1, 0, 0, DROPDOWN_MAX_HEIGHT)
dropdown.Position = UDim2.new(0, 0, 1, 4)
dropdown.BackgroundColor3 = THEME.surface2
dropdown.BorderSizePixel = 0
dropdown.Visible = false
dropdown.ScrollBarThickness = 6
dropdown.CanvasSize = UDim2.new(0, 0, 0, 0)
dropdown.ZIndex = 9
dropdown.Parent = targetRow
round(dropdown, RADIUS-4)
stroke(dropdown, 1, THEME.text, 0.88)

local dropdownList = Instance.new("UIListLayout", dropdown)
dropdownList.Padding = UDim.new(0, 2)

-- Fix #2: Properly clear old dropdown buttons to prevent memory leak
local function updateDropdown(searchText)
	-- Clear all existing buttons first
	for _, child in ipairs(dropdown:GetChildren()) do
		if child:IsA("TextButton") then 
			child:Destroy() 
		end
	end
	
	searchText = (searchText or ""):lower()
	local results = {}
	
	-- Prioritize prefix matches
	for _, p in ipairs(Players:GetPlayers()) do
		local nm = p.Name:lower()
		if searchText == "" or nm:sub(1, #searchText) == searchText then 
			table.insert(results, p) 
		end
	end
	
	-- Then substring matches
	for _, p in ipairs(Players:GetPlayers()) do
		local nm = p.Name:lower()
		if searchText ~= "" and nm:find(searchText, 1, true) and nm:sub(1, #searchText) ~= searchText then 
			table.insert(results, p) 
		end
	end
	
	-- Limit results to prevent lag
	local maxResults = 10
	for i = 1, math.min(#results, maxResults) do
		local p = results[i]
		local btn = Instance.new("TextButton")
		btn.Size = UDim2.new(1, -8, 0, 28)
		btn.BackgroundColor3 = THEME.surface
		btn.Text = p.Name
		btn.Font = Enum.Font.Gotham
		btn.TextSize = 14
		btn.TextColor3 = THEME.text
		btn.TextXAlignment = Enum.TextXAlignment.Left
		btn.ZIndex = 10
		btn.Parent = dropdown
		
		local pad = Instance.new("UIPadding", btn)
		pad.PaddingLeft = UDim.new(0, 10)
		round(btn, RADIUS-6)
		stroke(btn, 1, THEME.text, 0.9)
		
		safeConnect(btn.MouseButton1Click, function()
			box.Text = p.Name
			dropdown.Visible = false
			rewireForTarget(p)
		end)
	end
	
	dropdown.CanvasSize = UDim2.new(0, 0, 0, dropdownList.AbsoluteContentSize.Y)
end

local typingDebounce = false
safeConnect(box:GetPropertyChangedSignal("Text"), function()
	if not box:IsFocused() or typingDebounce then return end
	typingDebounce = true
	task.delay(SEARCH_DEBOUNCE_TIME, function()
		typingDebounce = false
		updateDropdown(box.Text)
	end)
end)

safeConnect(box.Focused, function() 
	updateDropdown(box.Text)
	dropdown.Visible = true 
end)

safeConnect(box.FocusLost, function(enterPressed) 
	task.wait(0.1) 
	dropdown.Visible = false
	if enterPressed then
		local target = (box.Text == "" and player) or Players:FindFirstChild(box.Text)
		if target then rewireForTarget(target) end
	end
end)

-- Fix #14: Close dropdown when clicking outside
safeConnect(UserInputService.InputBegan, function(input, gpe)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		if dropdown.Visible and not box:IsFocused() then
			local mousePos = UserInputService:GetMouseLocation()
			local dropdownPos = dropdown.AbsolutePosition
			local dropdownSize = dropdown.AbsoluteSize
			
			if mousePos.X < dropdownPos.X or mousePos.X > dropdownPos.X + dropdownSize.X or
			   mousePos.Y < dropdownPos.Y or mousePos.Y > dropdownPos.Y + dropdownSize.Y then
				dropdown.Visible = false
			end
		end
	end
end)

--------------------------
-- Tabs + Content Layout
--------------------------
local tabsRow = Instance.new("Frame")
tabsRow.BackgroundTransparency = 1
tabsRow.LayoutOrder = 2
tabsRow.Parent = contentFrame

local tabContainer = Instance.new("Frame")
tabContainer.BackgroundTransparency = 1
tabContainer.Size = UDim2.new(1,0,1,0)
tabContainer.Parent = tabsRow

local function makeTabButton(text, pos)
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(0.48, 0, 1, 0)
	btn.Position = UDim2.new(pos, 0, 0, 0)
	btn.Text = text
	btn.Font = Enum.Font.GothamBold
	btn.TextSize = 14
	btn.BackgroundColor3 = THEME.surface2
	btn.TextColor3 = THEME.textSubtle
	btn.BorderSizePixel = 0
	btn.AutoButtonColor = false
	btn.Parent = tabContainer
	round(btn, RADIUS-4)
	stroke(btn, 1, THEME.text, 0.88)
	
	safeConnect(btn.MouseEnter, function()
		if SETTINGS.Animations and not SETTINGS.FPSSaver and btn.BackgroundColor3 ~= THEME.accent then
			playTween("tab_hover_" .. text, btn, TweenInfo.new(TWEEN_SPEED_NORMAL), {
				BackgroundColor3 = Color3.fromRGB(40, 45, 50)
			})
		end
	end)
	
	safeConnect(btn.MouseLeave, function()
		if SETTINGS.Animations and not SETTINGS.FPSSaver and btn.BackgroundColor3 ~= THEME.accent then
			playTween("tab_leave_" .. text, btn, TweenInfo.new(TWEEN_SPEED_NORMAL), {
				BackgroundColor3 = THEME.surface2
			})
		end
	end)
	
	return btn
end

local tab1Btn = makeTabButton("BIO DATA", 0.00)
local tab2Btn = makeTabButton("STATS",    0.52)

local contentRow = Instance.new("Frame")
contentRow.BackgroundTransparency = 1
contentRow.LayoutOrder = 3
contentRow.Size = UDim2.new(1,0,0,9999)
contentRow.Parent = contentFrame

local tabsHolder = Instance.new("Frame")
tabsHolder.Size = UDim2.new(1,0,1,0)
tabsHolder.BackgroundTransparency = 1
tabsHolder.Parent = contentRow

local tab1Content = Instance.new("Frame")
tab1Content.Size = UDim2.new(1,0,1,0)
tab1Content.BackgroundTransparency = 1
tab1Content.Visible = true
tab1Content.Parent = tabsHolder

local t1Pad = Instance.new("UIPadding", tab1Content)
t1Pad.PaddingTop = UDim.new(0,8)
t1Pad.PaddingLeft = UDim.new(0,10)
t1Pad.PaddingRight = UDim.new(0,10)
local t1Layout = Instance.new("UIListLayout", tab1Content)
t1Layout.FillDirection = Enum.FillDirection.Vertical
t1Layout.Padding = UDim.new(0,6)

local tab2Content = Instance.new("Frame")
tab2Content.Size = UDim2.new(1,0,1,0)
tab2Content.BackgroundTransparency = 1
tab2Content.Visible = false
tab2Content.Parent = tabsHolder

local t2Pad = Instance.new("UIPadding", tab2Content)
t2Pad.PaddingTop = UDim.new(0,8)
t2Pad.PaddingLeft = UDim.new(0,10)
t2Pad.PaddingRight = UDim.new(0,10)
local t2Layout = Instance.new("UIListLayout", tab2Content)
t2Layout.FillDirection = Enum.FillDirection.Vertical
t2Layout.Padding = UDim.new(0,6)

local function setTabVisual(activeBtn, inactiveBtn)
	if SETTINGS.Animations and not SETTINGS.FPSSaver then
		playTween("tab_active", activeBtn, TweenInfo.new(TWEEN_SPEED_SLOW, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
			BackgroundColor3 = THEME.accent,
			TextColor3 = THEME.text
		})
		playTween("tab_inactive", inactiveBtn, TweenInfo.new(TWEEN_SPEED_SLOW, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
			BackgroundColor3 = THEME.surface2,
			TextColor3 = THEME.textSubtle
		})
	else
		activeBtn.BackgroundColor3 = THEME.accent
		activeBtn.TextColor3 = THEME.text
		inactiveBtn.BackgroundColor3 = THEME.surface2
		inactiveBtn.TextColor3 = THEME.textSubtle
	end
end

-- Fix #13: Remember active tab
local function switchTab(n)
	tab1Content.Visible = (n==1)
	tab2Content.Visible = (n==2)
	SETTINGS.ActiveTab = n
	if n==1 then setTabVisual(tab1Btn, tab2Btn) else setTabVisual(tab2Btn, tab1Btn) end
	-- Fix #3: Only refresh visible tab
	if currentTarget then
		if n == 1 then updateTab1(currentTarget)
		else updateTab2(currentTarget) end
	end
end

safeConnect(tab1Btn.MouseButton1Click, function() switchTab(1) end)
safeConnect(tab2Btn.MouseButton1Click, function() switchTab(2) end)
switchTab(SETTINGS.ActiveTab)

local function makeLabel(name, parent)
	local lbl = Instance.new("TextLabel")
	lbl.Name = name
	lbl.Size = UDim2.new(1, 0, 0, SETTINGS.CompactMode and 20 or 22)
	lbl.BackgroundTransparency = 1
	lbl.Font = Enum.Font.Gotham
	lbl.TextSize = SETTINGS.CompactMode and 14 or 16
	lbl.TextColor3 = Color3.fromRGB(200, 255, 200)
	lbl.Text = name .. ": [N/A]"
	lbl.TextXAlignment = Enum.TextXAlignment.Left
	lbl.Parent = parent
	return lbl
end

-- Tab 1 labels
local tab1Labels = {
	Subject = makeLabel("Subject", tab1Content),
	Exposure = makeLabel("Exposure", tab1Content),
	Strength = makeLabel("Strength", tab1Content),
	Agility = makeLabel("Agility", tab1Content),
	Intelligence = makeLabel("Intelligence", tab1Content),
	MutationType = makeLabel("MutationType", tab1Content),
	PotentialEvolution = makeLabel("PotentialEvolution", tab1Content),
	HasReachedAdvancedMutation = makeLabel("AdvancedMutation", tab1Content),
	Weight = makeLabel("Weight", tab1Content),
	Health = makeLabel("Health", tab1Content),
}

-- Tab 2 labels
local tab2Labels = {
	Resilience = makeLabel("Resilience", tab2Content),
	["Max Resilience"] = makeLabel("Max Resilience", tab2Content),
	WalkSpeed = makeLabel("WalkSpeed", tab2Content),
	["Speed Difference"] = makeLabel("Speed Difference", tab2Content),
	["Region Code"] = makeLabel("Region Code", tab2Content),
	["Is Elite"] = makeLabel("Is Elite", tab2Content),
	["Current Zone"] = makeLabel("Current Zone", tab2Content),
	Credits = makeLabel("Credits", tab2Content),
	["Active Perks"] = makeLabel("Active Perks", tab2Content),
}

---------------------------
-- Footer: Bars at bottom
---------------------------
local function makeBarRow(labelText)
	local row = Instance.new("Frame")
	row.BackgroundTransparency = 1
	row.Size = UDim2.new(1,0,0,30)
	row.Parent = footer

	local lab = Instance.new("TextLabel")
	lab.BackgroundTransparency = 1
	lab.Size = UDim2.new(0.22,0,1,0)
	lab.Font = Enum.Font.GothamBold
	lab.TextSize = 14
	lab.TextXAlignment = Enum.TextXAlignment.Left
	lab.TextColor3 = THEME.text
	lab.Text = labelText
	lab.Parent = row

	local bg = Instance.new("Frame")
	bg.Size = UDim2.new(0.76,0,0.56,0)
	bg.Position = UDim2.new(0.23,0,0.22,0)
	bg.BackgroundColor3 = THEME.surface
	bg.Parent = row
	round(bg, RADIUS-6)
	stroke(bg, 1, THEME.text, 0.88)

	local fill = Instance.new("Frame")
	fill.Size = UDim2.new(0,0,1,0)
	fill.BorderSizePixel = 0
	fill.Parent = bg
	round(fill, RADIUS-6)

	return fill
end

local healthBar = makeBarRow("Health")
local resilienceBar = makeBarRow("Resilience")

-- Fix #7: Properly implement colorblind mode
local function applyBarColors()
	local h1, h2, r1, r2
	if SETTINGS.ColorblindBars then
		h1, h2 = THEME.barH1_CB, THEME.barH2_CB
		r1, r2 = THEME.barR1_CB, THEME.barR2_CB
	else
		h1, h2 = THEME.barH1, THEME.barH2
		r1, r2 = THEME.barR1, THEME.barR2
	end

	if not SETTINGS.FPSSaver then
		-- Clear old gradients
		for _, f in ipairs({healthBar, resilienceBar}) do
			for _, ch in ipairs(f:GetChildren()) do 
				if ch:IsA("UIGradient") then ch:Destroy() end 
			end
		end
		local g1 = Instance.new("UIGradient")
		g1.Color = ColorSequence.new{ColorSequenceKeypoint.new(0,h1), ColorSequenceKeypoint.new(1,h2)}
		g1.Parent = healthBar
		
		local g2 = Instance.new("UIGradient")
		g2.Color = ColorSequence.new{ColorSequenceKeypoint.new(0,r1), ColorSequenceKeypoint.new(1,r2)}
		g2.Parent = resilienceBar
	else
		-- Solid colors for FPS saver mode
		healthBar.BackgroundColor3 = h1
		resilienceBar.BackgroundColor3 = r1
	end
end
applyBarColors()

local function tweenBar(fill, pct, barName)
	pct = math.clamp(pct, 0, 1)
	if SETTINGS.Animations and not SETTINGS.FPSSaver then
		playTween("bar_" .. barName, fill, TweenInfo.new(TWEEN_SPEED_NORMAL, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
			Size = UDim2.new(pct, 0, 1, 0)
		})
	else
		fill.Size = UDim2.new(pct, 0, 1, 0)
	end
end

-------------------------------
-- Event-driven data updates
-------------------------------
local function getCharacter(p) 
	return p and p.Character or nil 
end

local currentTarget = nil
local connections = {}

local function disconnectAll()
	for _, c in ipairs(connections) do
		pcall(function() c:Disconnect() end)
	end
	table.clear(connections)
end

-- Fix #9: Add error handling to all attribute reads
local function getPlayerAttr(targetPlayer, attrName)
	if not targetPlayer then return nil end
	local success, result = pcall(function()
		return targetPlayer:GetAttribute(attrName)
	end)
	return success and result or nil
end

local function getCharAttr(char, attrName)
	if not char then return nil end
	local success, result = pcall(function()
		return char:GetAttribute(attrName)
	end)
	return success and result or nil
end

local function getHealth(char)
	local success, humanoid = pcall(function()
		return char and char:FindFirstChildOfClass("Humanoid")
	end)
	if success and humanoid then
		local hSuccess, h, mh = pcall(function()
			return humanoid.Health, humanoid.MaxHealth
		end)
		if hSuccess then return h, mh, humanoid end
	end
	return nil, nil, nil
end

local function updateTab1(targetPlayer)
	if not targetPlayer then
		for _, lbl in pairs(tab1Labels) do lbl.Text = "[NO DATA]" end
		tweenBar(healthBar, 0, "health")
		return
	end

	local char = getCharacter(targetPlayer)
	
	pcall(function()
		tab1Labels.Subject.Text = "Subject: " .. targetPlayer.Name

		tab1Labels.Exposure.Text = "Exposure: " .. tostring(getPlayerAttr(targetPlayer, "Exposure") or "N/A")
		tab1Labels.Strength.Text = "Strength: " .. tostring(getPlayerAttr(targetPlayer, "StrengthAttribute") or "N/A")
		tab1Labels.Agility.Text = "Agility: " .. tostring(getPlayerAttr(targetPlayer, "AgilityAttribute") or "N/A")
		tab1Labels.Intelligence.Text = "Intelligence: " .. tostring(getPlayerAttr(targetPlayer, "IntelligenceAttribute") or "N/A")
		tab1Labels.MutationType.Text = "MutationType: " .. tostring(getPlayerAttr(targetPlayer, "MutationType") or "N/A")
		tab1Labels.PotentialEvolution.Text = "PotentialEvolution: " .. tostring(getPlayerAttr(targetPlayer, "PotentialEvolution") or "N/A")
		tab1Labels.HasReachedAdvancedMutation.Text = "AdvancedMutation: " .. tostring(getPlayerAttr(targetPlayer, "HasReachedAdvancedMutation") or "N/A")

		local weight = getPlayerAttr(targetPlayer, "Weight")
		local wtext = "Weight: " .. tostring(weight or "N/A")
		if type(weight) == "number" then
			wtext = wtext .. " kg"
			local c = Color3.fromRGB(200,255,200)
			if math.abs(weight - 77.2) < 1e-6 then 
				c = Color3.fromRGB(255,215,0)
				wtext = wtext .. " [PERFECT]"
			elseif weight >= 60 and weight < 80 then 
				c = Color3.fromRGB(100,255,100)
				wtext = wtext .. " [Average]"
			elseif weight >= 80 and weight <= 120 then 
				c = Color3.fromRGB(255,150,100)
				wtext = wtext .. " [Overweight]"
			elseif weight >= 50 and weight < 60 then 
				c = Color3.fromRGB(150,200,255)
				wtext = wtext .. " [Underweight]"
			else 
				c = Color3.fromRGB(255,100,100)
				wtext = wtext .. " [Out of Range]"
			end
			tab1Labels.Weight.TextColor3 = c
		else
			tab1Labels.Weight.TextColor3 = Color3.fromRGB(200,255,200)
		end
		tab1Labels.Weight.Text = wtext

		if char then
			local h, mh = getHealth(char)
			if h and mh and mh > 0 then
				tab1Labels.Health.Text = string.format("Health: %d / %d", h, mh)
				tweenBar(healthBar, h/mh, "health")
			else
				tab1Labels.Health.Text = "Health: N/A"
				tweenBar(healthBar, 0, "health")
			end
		else
			tab1Labels.Health.Text = "Health: N/A"
			tweenBar(healthBar, 0, "health")
		end
	end)
end

local function updateTab2(targetPlayer)
	if not targetPlayer then
		for _, lbl in pairs(tab2Labels) do lbl.Text = "[NO DATA]" end
		tweenBar(resilienceBar, 0, "resilience")
		return
	end

	local char = getCharacter(targetPlayer)
	
	pcall(function()
		local r = getPlayerAttr(targetPlayer, "Resilience") or getCharAttr(char, "Resilience")
		local mr = getPlayerAttr(targetPlayer, "MaxResilience") or getCharAttr(char, "MaxResilience")

		tab2Labels.Resilience.Text = "Resilience: " .. tostring(r or "N/A")
		tab2Labels["Max Resilience"].Text = "Max Resilience: " .. tostring(mr or "N/A")

		if type(r) == "number" and type(mr) == "number" and mr > 0 then
			tweenBar(resilienceBar, r/mr, "resilience")
		else
			tweenBar(resilienceBar, 0, "resilience")
		end

		if char then
			local humanoid = char:FindFirstChildOfClass("Humanoid")
			if humanoid then
				local s = humanoid.WalkSpeed
				local d = SETTINGS.DefaultSpeed
				local rs = SETTINGS.RunSpeed
				local diff = s - d
				local diffText = (diff >= 0 and "+" or "") .. string.format("%.1f", diff)
				tab2Labels.WalkSpeed.Text = string.format("WalkSpeed: %.1f", s)
				tab2Labels["Speed Difference"].Text = string.format("Speed Difference: %s (Default: %g | Run: %g)", diffText, d, rs)
			else
				tab2Labels.WalkSpeed.Text = "WalkSpeed: N/A"
				tab2Labels["Speed Difference"].Text = "Speed Difference: N/A"
			end
		else
			tab2Labels.WalkSpeed.Text = "WalkSpeed: N/A"
			tab2Labels["Speed Difference"].Text = "Speed Difference: N/A"
		end

		local regionCode = getPlayerAttr(targetPlayer, "RegionCode") or getCharAttr(char, "RegionCode")
		local isElite = getPlayerAttr(targetPlayer, "IsElite") or getCharAttr(char, "IsElite")
		local currentZone = getPlayerAttr(targetPlayer, "CurrentZone") or getCharAttr(char, "CurrentZone")
		
		tab2Labels["Region Code"].Text = "Region Code: " .. tostring(regionCode or "N/A")
		tab2Labels["Is Elite"].Text = "Is Elite: " .. tostring(isElite or "N/A")
		tab2Labels["Current Zone"].Text = "Current Zone: " .. tostring(currentZone or "N/A")

		local dataFolder = targetPlayer:FindFirstChild("Data")
		local credits = "N/A"
		if dataFolder then
			local creditsValue = dataFolder:FindFirstChild("Credits")
			if creditsValue and type(creditsValue.Value) == "number" then
				local amount = math.floor(creditsValue.Value)
				credits = tostring(amount):reverse():gsub("(%d%d%d)", "%1,"):reverse():gsub("^,", "")
			end
		end
		tab2Labels.Credits.Text = "Credits: " .. credits

		local perks = {}
		if dataFolder then
			for _, child in ipairs(dataFolder:GetChildren()) do
				if (child:IsA("BoolValue") and child.Value) or
				   (child:IsA("IntValue") and child.Value > 0 and child.Name:lower():find("perk")) then
					table.insert(perks, child.Name)
				end
			end
		end
		tab2Labels["Active Perks"].Text = (#perks > 0) and ("Active Perks: " .. table.concat(perks, ", ")) or "Active Perks: None"
	end)
end

-- Fix #3: Only refresh visible tab
local function refreshAll()
	if currentTarget then
		if SETTINGS.ActiveTab == 1 then
			updateTab1(currentTarget)
		else
			updateTab2(currentTarget)
		end
	else
		for _, l in pairs(tab1Labels) do l.Text = "[NO DATA]" end
		for _, l in pairs(tab2Labels) do l.Text = "[NO DATA]" end
		tweenBar(healthBar, 0, "health")
		tweenBar(resilienceBar, 0, "resilience")
	end
end

-- Fix #6: Split bindForTarget into smaller functions
local function bindHumanoidSignals(targetPlayer)
	local char = getCharacter(targetPlayer)
	local hum = char and char:FindFirstChildOfClass("Humanoid")
	if hum then
		local c1 = safeConnect(hum.HealthChanged, function() 
			if SETTINGS.ActiveTab == 1 then updateTab1(targetPlayer) end
		end)
		local c2 = safeConnect(hum:GetPropertyChangedSignal("MaxHealth"), function() 
			if SETTINGS.ActiveTab == 1 then updateTab1(targetPlayer) end
		end)
		local c3 = safeConnect(hum:GetPropertyChangedSignal("WalkSpeed"), function() 
			if SETTINGS.ActiveTab == 2 then updateTab2(targetPlayer) end
		end)
		if c1 then table.insert(connections, c1) end
		if c2 then table.insert(connections, c2) end
		if c3 then table.insert(connections, c3) end
	end
end

local function bindAttributeSignals(targetPlayer)
	local c1 = safeConnect(targetPlayer.AttributeChanged, function()
		if SETTINGS.ActiveTab == 1 then updateTab1(targetPlayer) end
		if SETTINGS.ActiveTab == 2 then updateTab2(targetPlayer) end
	end)
	if c1 then table.insert(connections, c1) end
	
	local char = getCharacter(targetPlayer)
	if char then
		local c2 = safeConnect(char.AttributeChanged, function()
			if SETTINGS.ActiveTab == 1 then updateTab1(targetPlayer) end
			if SETTINGS.ActiveTab == 2 then updateTab2(targetPlayer) end
		end)
		if c2 then table.insert(connections, c2) end
	end
end

local function bindDataFolderSignals(targetPlayer)
	local dataFolder = targetPlayer:FindFirstChild("Data")
	if dataFolder then
		local c1 = safeConnect(dataFolder.ChildAdded, function() 
			if SETTINGS.ActiveTab == 2 then updateTab2(targetPlayer) end
		end)
		local c2 = safeConnect(dataFolder.ChildRemoved, function() 
			if SETTINGS.ActiveTab == 2 then updateTab2(targetPlayer) end
		end)
		if c1 then table.insert(connections, c1) end
		if c2 then table.insert(connections, c2) end
		
		for _, child in ipairs(dataFolder:GetChildren()) do
			local c3 = safeConnect(child.Changed, function() 
				if SETTINGS.ActiveTab == 2 then updateTab2(targetPlayer) end
			end)
			if c3 then table.insert(connections, c3) end
		end
	end
end

-- Fix #5: Replace polling with event-driven updates
local safetyRefreshThread = nil
local function startSafetyRefresh(targetPlayer)
	if safetyRefreshThread then
		task.cancel(safetyRefreshThread)
		safetyRefreshThread = nil
	end
	
	if SETTINGS.SafetyRefreshSeconds and SETTINGS.SafetyRefreshSeconds > 0 then
		safetyRefreshThread = task.spawn(function()
			local thisTarget = targetPlayer
			while currentTarget == thisTarget and SETTINGS.SafetyRefreshSeconds > 0 do
				task.wait(SETTINGS.SafetyRefreshSeconds)
				if currentTarget == thisTarget then 
					refreshAll() 
				end
			end
		end)
		
		addCleanupTask(function()
			if safetyRefreshThread then
				task.cancel(safetyRefreshThread)
			end
		end)
	end
end

local function bindForTarget(targetPlayer)
	disconnectAll()
	if not targetPlayer then 
		refreshAll()
		return 
	end

	local c1 = safeConnect(targetPlayer.CharacterAdded, function()
		task.defer(refreshAll)
		task.delay(0.05, function() bindHumanoidSignals(targetPlayer) end)
	end)
	if c1 then table.insert(connections, c1) end
	
	bindHumanoidSignals(targetPlayer)
	bindAttributeSignals(targetPlayer)
	bindDataFolderSignals(targetPlayer)
	startSafetyRefresh(targetPlayer)
end

function rewireForTarget(targetPlayer)
	currentTarget = targetPlayer
	refreshAll()
	bindForTarget(targetPlayer)
end

-- Default target = self
rewireForTarget(player)

-------------------
-- Settings Panel
-------------------
local settingsPanel = Instance.new("Frame")
settingsPanel.Visible = false
settingsPanel.ZIndex = 300
settingsPanel.Size = UDim2.new(0, 290, 0, 330)
settingsPanel.Position = UDim2.new(1, -300, 0, TITLE_H + 8)
settingsPanel.BackgroundColor3 = THEME.surface2
settingsPanel.Parent = frame
round(settingsPanel, RADIUS-2)
stroke(settingsPanel, 1, THEME.text, 0.85)

local spPad = Instance.new("UIPadding", settingsPanel)
spPad.PaddingTop = UDim.new(0,8); spPad.PaddingBottom = UDim.new(0,8)
spPad.PaddingLeft = UDim.new(0,8); spPad.PaddingRight = UDim.new(0,8)

local spList = Instance.new("UIListLayout", settingsPanel)
spList.FillDirection = Enum.FillDirection.Vertical
spList.Padding = UDim.new(0,6)

local function addRow(h)
	local r = Instance.new("Frame")
	r.BackgroundTransparency = 1
	r.Size = UDim2.new(1,0,0,h)
	r.Parent = settingsPanel
	return r
end

local function addHeader(text)
	local row = addRow(24)
	local h = Instance.new("TextLabel")
	h.BackgroundTransparency = 1
	h.TextXAlignment = Enum.TextXAlignment.Left
	h.Font = Enum.Font.GothamBold
	h.TextSize = 13
	h.TextColor3 = THEME.accent
	h.Text = text
	h.Size = UDim2.new(1,0,1,0)
	h.ZIndex = 301
	h.Parent = row
end

local function toggleRow(label, getter, setter)
	local row = addRow(28)
	local t = Instance.new("TextLabel")
	t.BackgroundTransparency = 1
	t.TextXAlignment = Enum.TextXAlignment.Left
	t.Font = Enum.Font.Gotham
	t.TextSize = 14
	t.TextColor3 = THEME.text
	t.Text = label
	t.Size = UDim2.new(1,-44,1,0)
	t.ZIndex = 301
	t.Parent = row

	local b = Instance.new("TextButton")
	b.Size = UDim2.new(0,36,0,22)
	b.Position = UDim2.new(1,-40,0.5,-11)
	b.Text = getter() and "ON" or "OFF"
	b.Font = Enum.Font.GothamBold
	b.TextSize = 12
	b.TextColor3 = THEME.text
	b.BackgroundColor3 = getter() and THEME.accent or THEME.surface
	b.ZIndex = 301
	b.Parent = row
	round(b, 10)
	
	safeConnect(b.MouseEnter, function()
		if SETTINGS.Animations and not SETTINGS.FPSSaver then
			playTween("setting_hover_" .. label, b, TweenInfo.new(TWEEN_SPEED_NORMAL), {
				BackgroundColor3 = getter() and THEME.accentHi or Color3.fromRGB(50, 55, 60)
			})
		end
	end)
	
	safeConnect(b.MouseLeave, function()
		if SETTINGS.Animations and not SETTINGS.FPSSaver then
			playTween("setting_leave_" .. label, b, TweenInfo.new(TWEEN_SPEED_NORMAL), {
				BackgroundColor3 = getter() and THEME.accent or THEME.surface
			})
		end
	end)
	
	safeConnect(b.MouseButton1Click, function()
		local v = not getter()
		setter(v)
		b.Text = v and "ON" or "OFF"
		
		if SETTINGS.Animations and not SETTINGS.FPSSaver then
			cancelTween("setting_click_" .. label)
			playTween("setting_click_shrink_" .. label, b, TweenInfo.new(0.1), {Size = UDim2.new(0,32,0,20)})
			task.wait(0.1)
			local t = playTween("setting_click_grow_" .. label, b, TweenInfo.new(TWEEN_SPEED_NORMAL, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
				Size = UDim2.new(0,36,0,22),
				BackgroundColor3 = v and THEME.accent or THEME.surface
			})
		else
			b.BackgroundColor3 = v and THEME.accent or THEME.surface
		end
		
		notify(label .. ": " .. (v and "ON" or "OFF"), THEME.textSubtle)
		
		if label == "Colorblind Bars" then 
			applyBarColors()
			refreshAll() 
		end
		if label == "Compact Mode" then
			for _, l in pairs(tab1Labels) do 
				l.TextSize = v and 14 or 16
				l.Size = UDim2.new(1,0,0,v and 20 or 22) 
			end
			for _, l in pairs(tab2Labels) do 
				l.TextSize = v and 14 or 16
				l.Size = UDim2.new(1,0,0,v and 20 or 22) 
			end
			box.TextSize = v and 14 or 16
		end
	end)
end

local function numberRow(label, getter, setter, minVal, maxVal)
	local row = addRow(28)
	local t = Instance.new("TextLabel")
	t.BackgroundTransparency = 1
	t.TextXAlignment = Enum.TextXAlignment.Left
	t.Font = Enum.Font.Gotham
	t.TextSize = 14
	t.TextColor3 = THEME.text
	t.Text = label
	t.Size = UDim2.new(1,-80,1,0)
	t.ZIndex = 301
	t.Parent = row

	local b = Instance.new("TextBox")
	b.Size = UDim2.new(0,70,0,22)
	b.Position = UDim2.new(1,-74,0.5,-11)
	b.BackgroundColor3 = THEME.surface
	b.TextColor3 = THEME.text
	b.Font = Enum.Font.Gotham
	b.TextSize = 14
	b.ClearTextOnFocus = false
	b.Text = tostring(getter())
	b.ZIndex = 301
	b.Parent = row
	round(b, 8)
	stroke(b, 1, THEME.text, 0.88)
	
	safeConnect(b.FocusLost, function()
		local v = tonumber(b.Text)
		if v then
			if minVal and v < minVal then v = minVal end
			if maxVal and v > maxVal then v = maxVal end
			setter(v)
		end
		b.Text = tostring(getter())
		notify(label .. ": " .. b.Text, THEME.textSubtle)
		if label:find("Speed") then 
			if SETTINGS.ActiveTab == 2 then updateTab2(currentTarget or player) end
		end
		if label:find("Safety") then
			startSafetyRefresh(currentTarget)
		end
	end)
end

-- Build settings
addHeader("‚îÅ‚îÅ DISPLAY ‚îÅ‚îÅ")
toggleRow("Animations", function() return SETTINGS.Animations end, function(v) SETTINGS.Animations=v end)
toggleRow("Compact Mode", function() return SETTINGS.CompactMode end, function(v) SETTINGS.CompactMode=v end)
toggleRow("Colorblind Bars", function() return SETTINGS.ColorblindBars end, function(v) SETTINGS.ColorblindBars=v end)
toggleRow("FPS Saver", function() return SETTINGS.FPSSaver end, function(v) SETTINGS.FPSSaver=v end)

addHeader("‚îÅ‚îÅ SPEED REFERENCE ‚îÅ‚îÅ")
numberRow("Default Speed", function() return SETTINGS.DefaultSpeed end, function(n) SETTINGS.DefaultSpeed=n end, 0, 100)
numberRow("Run Speed", function() return SETTINGS.RunSpeed end, function(n) SETTINGS.RunSpeed=n end, 0, 100)

addHeader("‚îÅ‚îÅ ADVANCED ‚îÅ‚îÅ")
numberRow("Safety Refresh (s)", function() return SETTINGS.SafetyRefreshSeconds end, function(n) SETTINGS.SafetyRefreshSeconds = math.max(0,n) end, 0, 60)

local settingsPanelOpen = false
safeConnect(settingsBtn.MouseButton1Click, function()
	settingsPanelOpen = not settingsPanelOpen
	
	if SETTINGS.Animations and not SETTINGS.FPSSaver then
		if settingsPanelOpen then
			settingsPanel.Visible = true
			settingsPanel.Size = UDim2.new(0, 290, 0, 0)
			playTween("settings_open", settingsPanel, TweenInfo.new(TWEEN_SPEED_EXPAND, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
				Size = UDim2.new(0, 290, 0, 330)
			})
		else
			playTween("settings_close", settingsPanel, TweenInfo.new(TWEEN_SPEED_SLOW, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
				Size = UDim2.new(0, 290, 0, 0)
			})
			task.wait(TWEEN_SPEED_SLOW)
			settingsPanel.Visible = false
		end
	else
		settingsPanel.Visible = settingsPanelOpen
	end
end)

----------------------------------------
-- HP Alert / Leave / Rejoin System
----------------------------------------
-- Fix #12: Position HP alert to not overlap settings
local hpAlert = Instance.new("TextLabel")
hpAlert.BackgroundColor3 = Color3.fromRGB(90,20,20)
hpAlert.TextColor3 = Color3.fromRGB(255,220,220)
hpAlert.Font = Enum.Font.GothamBold
hpAlert.TextSize = 14
hpAlert.TextWrapped = true
hpAlert.Visible = false
hpAlert.ZIndex = 250
hpAlert.Size = UDim2.new(0, 360, 0, 28)
hpAlert.AnchorPoint = Vector2.new(0, 0)
hpAlert.Position = UDim2.new(0, 10, 0, TITLE_H + 6)
hpAlert.Parent = frame
round(hpAlert, 8)
stroke(hpAlert, 1, THEME.danger, 0.25)

local function setHPBtnVisual()
	local col =
		(HPState.Mode == "ALERT" and THEME.warn) or
		(HPState.Mode == "LEAVE" and THEME.danger) or
		(HPState.Mode == "REJOIN" and THEME.accentHi) or
		THEME.text
	hpBtn.TextColor3 = HPState.Enabled and col or THEME.textSubtle
end
setHPBtnVisual()

safeConnect(hpBtn.MouseButton2Click, function()
	if HPState.Mode == "ALERT" then HPState.Mode = "LEAVE"
	elseif HPState.Mode == "LEAVE" then HPState.Mode = "REJOIN"
	else HPState.Mode = "ALERT" end
	setHPBtnVisual()
	notify("HP mode: " .. HPState.Mode, THEME.textSubtle)
end)

safeConnect(hpBtn.MouseButton1Click, function()
	HPState.Enabled = not HPState.Enabled
	setHPBtnVisual()
	notify("HP system " .. (HPState.Enabled and "ENABLED" or "DISABLED"), THEME.textSubtle)
end)

local lastHealth
local humConn

local function unbindHP() 
	if humConn then 
		pcall(function() humConn:Disconnect() end)
		humConn = nil 
	end 
end

local function bindHP()
	unbindHP()
	
	local success, char = pcall(function()
		return player.Character or player.CharacterAdded:Wait()
	end)
	
	if not success then return end
	
	local hum = char:FindFirstChildOfClass("Humanoid")
	if not hum then 
		local childAdded = char.ChildAdded:Wait()
		hum = char:FindFirstChildOfClass("Humanoid")
	end
	
	lastHealth = hum and hum.Health or nil
	
	if hum then
		humConn = safeConnect(hum.HealthChanged, function(newH)
			if not HPState.Enabled then 
				lastHealth = newH
				return 
			end
			
			local old = lastHealth or newH
			lastHealth = newH
			local drop = math.max(0, old - newH)
			if drop <= 0 then return end

			if HPState.Mode == "ALERT" then
				hpAlert.Text = ("‚ö† HP LOSS DETECTED ‚Äî Lost %d HP | Current: %d"):format(math.floor(drop), math.floor(newH))
				hpAlert.Visible = true
				hpAlert.BackgroundTransparency = 0
				hpAlert.TextTransparency = 0
				
				if SETTINGS.Animations and not SETTINGS.FPSSaver then
					playTween("hp_alert_show", hpAlert, TweenInfo.new(TWEEN_SPEED_NORMAL), {
						BackgroundTransparency = 0,
						TextTransparency = 0
					})
				end
				
				task.delay(HP_ALERT_DURATION, function()
					if hpAlert and hpAlert.Visible then
						if SETTINGS.Animations and not SETTINGS.FPSSaver then
							local t = playTween("hp_alert_hide", hpAlert, TweenInfo.new(0.22), {
								BackgroundTransparency = 1,
								TextTransparency = 1
							})
							t.Completed:Wait()
						end
						hpAlert.Visible = false
					end
				end)
				notify(("HP -%d (now %d)"):format(math.floor(drop), math.floor(newH)), THEME.warn)

			elseif HPState.Mode == "LEAVE" then
				notify("HP drop detected ‚Äî disconnecting...", THEME.danger)
				-- Fix #22: Add error handling for kick
				pcall(function() 
					player:Kick("Disconnected by HP Alert") 
				end)

			elseif HPState.Mode == "REJOIN" then
				notify("HP drop detected ‚Äî rejoining...", THEME.accentHi)
				task.delay(0.4, function()
					-- Fix #22: Add error handling for teleport
					local success, err = pcall(function() 
						TeleportService:Teleport(game.PlaceId, player) 
					end)
					if not success then
						notify("Failed to rejoin: " .. tostring(err), THEME.danger)
					end
				end)
			end
		end)
	end
end

safeConnect(player.CharacterAdded, function() 
	task.defer(bindHP) 
end)

if player.Character then 
	bindHP() 
else 
	player.CharacterAdded:Wait()
	bindHP() 
end

addCleanupTask(unbindHP)

------------------------------
-- Drag + Resize
------------------------------
do
	local dragging = false
	local dragInput
	local mousePos
	local framePos
	
	safeConnect(titleBar.InputBegan, function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = true
			mousePos = input.Position
			framePos = frame.Position
			
			local conn
			conn = safeConnect(input.Changed, function()
				if input.UserInputState == Enum.UserInputState.End then 
					dragging = false
					if conn then pcall(function() conn:Disconnect() end) end
				end
			end)
		end
	end)
	
	safeConnect(titleBar.InputChanged, function(input)
		if input.UserInputType == Enum.UserInputType.MouseMovement then 
			dragInput = input 
		end
	end)
	
	safeConnect(UserInputService.InputChanged, function(input)
		if input == dragInput and dragging then
			local delta = input.Position - mousePos
			frame.Position = UDim2.new(
				framePos.X.Scale, 
				framePos.X.Offset + delta.X, 
				framePos.Y.Scale, 
				framePos.Y.Offset + delta.Y
			)
		end
	end)

	local resizing = false
	local resizeStart
	local sizeStart
	
	local resizeHandle = Instance.new("TextButton")
	resizeHandle.Size = UDim2.new(0, 20, 0, 20)
	resizeHandle.Position = UDim2.new(1, -24, 1, -24)
	resizeHandle.Text = "‚ã∞"
	resizeHandle.Font = Enum.Font.GothamBold
	resizeHandle.TextSize = 16
	resizeHandle.TextColor3 = THEME.text
	resizeHandle.BackgroundTransparency = 1
	resizeHandle.ZIndex = 5
	resizeHandle.Parent = frame
	
	safeConnect(resizeHandle.InputBegan, function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			resizing = true
			resizeStart = input.Position
			sizeStart = frame.Size
			
			local conn
			conn = safeConnect(input.Changed, function()
				if input.UserInputState == Enum.UserInputState.End then 
					resizing = false
					if conn then pcall(function() conn:Disconnect() end) end
				end
			end)
		end
	end)
	
	safeConnect(UserInputService.InputChanged, function(input)
		if input.UserInputType == Enum.UserInputType.MouseMovement and resizing then
			local d = input.Position - resizeStart
			local newW = math.max(400, sizeStart.X.Offset + d.X)
			local newH = math.max(400, sizeStart.Y.Offset + d.Y)
			frame.Size = UDim2.new(0, newW, 0, newH)
			if not collapsed then 
				savedSize = frame.Size 
			end
		end
	end)
end

------------------------------
-- Keybind: toggle GUI
------------------------------
safeConnect(UserInputService.InputBegan, function(input, gpe)
	if gpe then return end
	if input.KeyCode == Enum.KeyCode.P then
		gui.Enabled = not gui.Enabled
	end
end)

------------------------------
-- Initial notification
------------------------------
task.defer(function()
	task.wait(0.5)
	notify("Bio-Scanner loaded! Press P to toggle.", THEME.accent)
end)
